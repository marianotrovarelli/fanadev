/*! For license information please see module.js.LICENSE.txt */
define(["react","@grafana/ui","@emotion/css","@grafana/runtime","lodash","@grafana/data"],(function(e,t,n,r,a,o){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=12)}([function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){e.exports=n},function(e,t){e.exports=r},function(e,t){e.exports=a},function(e,t){e.exports=o},function(e,t,n){(function(n){var r;t=e.exports=p,r="object"==typeof n&&n.env&&n.env.NODE_DEBUG&&/\bsemver\b/i.test(n.env.NODE_DEBUG)?function(){var e=Array.prototype.slice.call(arguments,0);e.unshift("SEMVER")}:function(){},t.SEMVER_SPEC_VERSION="2.0.0";var a=Number.MAX_SAFE_INTEGER||9007199254740991,o=t.re=[],i=t.src=[],u=t.tokens={},l=0;function s(e){u[e]=l++}s("NUMERICIDENTIFIER"),i[u.NUMERICIDENTIFIER]="0|[1-9]\\d*",s("NUMERICIDENTIFIERLOOSE"),i[u.NUMERICIDENTIFIERLOOSE]="[0-9]+",s("NONNUMERICIDENTIFIER"),i[u.NONNUMERICIDENTIFIER]="\\d*[a-zA-Z-][a-zA-Z0-9-]*",s("MAINVERSION"),i[u.MAINVERSION]="("+i[u.NUMERICIDENTIFIER]+")\\.("+i[u.NUMERICIDENTIFIER]+")\\.("+i[u.NUMERICIDENTIFIER]+")",s("MAINVERSIONLOOSE"),i[u.MAINVERSIONLOOSE]="("+i[u.NUMERICIDENTIFIERLOOSE]+")\\.("+i[u.NUMERICIDENTIFIERLOOSE]+")\\.("+i[u.NUMERICIDENTIFIERLOOSE]+")",s("PRERELEASEIDENTIFIER"),i[u.PRERELEASEIDENTIFIER]="(?:"+i[u.NUMERICIDENTIFIER]+"|"+i[u.NONNUMERICIDENTIFIER]+")",s("PRERELEASEIDENTIFIERLOOSE"),i[u.PRERELEASEIDENTIFIERLOOSE]="(?:"+i[u.NUMERICIDENTIFIERLOOSE]+"|"+i[u.NONNUMERICIDENTIFIER]+")",s("PRERELEASE"),i[u.PRERELEASE]="(?:-("+i[u.PRERELEASEIDENTIFIER]+"(?:\\."+i[u.PRERELEASEIDENTIFIER]+")*))",s("PRERELEASELOOSE"),i[u.PRERELEASELOOSE]="(?:-?("+i[u.PRERELEASEIDENTIFIERLOOSE]+"(?:\\."+i[u.PRERELEASEIDENTIFIERLOOSE]+")*))",s("BUILDIDENTIFIER"),i[u.BUILDIDENTIFIER]="[0-9A-Za-z-]+",s("BUILD"),i[u.BUILD]="(?:\\+("+i[u.BUILDIDENTIFIER]+"(?:\\."+i[u.BUILDIDENTIFIER]+")*))",s("FULL"),s("FULLPLAIN"),i[u.FULLPLAIN]="v?"+i[u.MAINVERSION]+i[u.PRERELEASE]+"?"+i[u.BUILD]+"?",i[u.FULL]="^"+i[u.FULLPLAIN]+"$",s("LOOSEPLAIN"),i[u.LOOSEPLAIN]="[v=\\s]*"+i[u.MAINVERSIONLOOSE]+i[u.PRERELEASELOOSE]+"?"+i[u.BUILD]+"?",s("LOOSE"),i[u.LOOSE]="^"+i[u.LOOSEPLAIN]+"$",s("GTLT"),i[u.GTLT]="((?:<|>)?=?)",s("XRANGEIDENTIFIERLOOSE"),i[u.XRANGEIDENTIFIERLOOSE]=i[u.NUMERICIDENTIFIERLOOSE]+"|x|X|\\*",s("XRANGEIDENTIFIER"),i[u.XRANGEIDENTIFIER]=i[u.NUMERICIDENTIFIER]+"|x|X|\\*",s("XRANGEPLAIN"),i[u.XRANGEPLAIN]="[v=\\s]*("+i[u.XRANGEIDENTIFIER]+")(?:\\.("+i[u.XRANGEIDENTIFIER]+")(?:\\.("+i[u.XRANGEIDENTIFIER]+")(?:"+i[u.PRERELEASE]+")?"+i[u.BUILD]+"?)?)?",s("XRANGEPLAINLOOSE"),i[u.XRANGEPLAINLOOSE]="[v=\\s]*("+i[u.XRANGEIDENTIFIERLOOSE]+")(?:\\.("+i[u.XRANGEIDENTIFIERLOOSE]+")(?:\\.("+i[u.XRANGEIDENTIFIERLOOSE]+")(?:"+i[u.PRERELEASELOOSE]+")?"+i[u.BUILD]+"?)?)?",s("XRANGE"),i[u.XRANGE]="^"+i[u.GTLT]+"\\s*"+i[u.XRANGEPLAIN]+"$",s("XRANGELOOSE"),i[u.XRANGELOOSE]="^"+i[u.GTLT]+"\\s*"+i[u.XRANGEPLAINLOOSE]+"$",s("COERCE"),i[u.COERCE]="(^|[^\\d])(\\d{1,16})(?:\\.(\\d{1,16}))?(?:\\.(\\d{1,16}))?(?:$|[^\\d])",s("COERCERTL"),o[u.COERCERTL]=new RegExp(i[u.COERCE],"g"),s("LONETILDE"),i[u.LONETILDE]="(?:~>?)",s("TILDETRIM"),i[u.TILDETRIM]="(\\s*)"+i[u.LONETILDE]+"\\s+",o[u.TILDETRIM]=new RegExp(i[u.TILDETRIM],"g");s("TILDE"),i[u.TILDE]="^"+i[u.LONETILDE]+i[u.XRANGEPLAIN]+"$",s("TILDELOOSE"),i[u.TILDELOOSE]="^"+i[u.LONETILDE]+i[u.XRANGEPLAINLOOSE]+"$",s("LONECARET"),i[u.LONECARET]="(?:\\^)",s("CARETTRIM"),i[u.CARETTRIM]="(\\s*)"+i[u.LONECARET]+"\\s+",o[u.CARETTRIM]=new RegExp(i[u.CARETTRIM],"g");s("CARET"),i[u.CARET]="^"+i[u.LONECARET]+i[u.XRANGEPLAIN]+"$",s("CARETLOOSE"),i[u.CARETLOOSE]="^"+i[u.LONECARET]+i[u.XRANGEPLAINLOOSE]+"$",s("COMPARATORLOOSE"),i[u.COMPARATORLOOSE]="^"+i[u.GTLT]+"\\s*("+i[u.LOOSEPLAIN]+")$|^$",s("COMPARATOR"),i[u.COMPARATOR]="^"+i[u.GTLT]+"\\s*("+i[u.FULLPLAIN]+")$|^$",s("COMPARATORTRIM"),i[u.COMPARATORTRIM]="(\\s*)"+i[u.GTLT]+"\\s*("+i[u.LOOSEPLAIN]+"|"+i[u.XRANGEPLAIN]+")",o[u.COMPARATORTRIM]=new RegExp(i[u.COMPARATORTRIM],"g");s("HYPHENRANGE"),i[u.HYPHENRANGE]="^\\s*("+i[u.XRANGEPLAIN]+")\\s+-\\s+("+i[u.XRANGEPLAIN]+")\\s*$",s("HYPHENRANGELOOSE"),i[u.HYPHENRANGELOOSE]="^\\s*("+i[u.XRANGEPLAINLOOSE]+")\\s+-\\s+("+i[u.XRANGEPLAINLOOSE]+")\\s*$",s("STAR"),i[u.STAR]="(<|>)?=?\\s*\\*";for(var c=0;c<l;c++)r(c,i[c]),o[c]||(o[c]=new RegExp(i[c]));function f(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof p)return e;if("string"!=typeof e)return null;if(e.length>256)return null;if(!(t.loose?o[u.LOOSE]:o[u.FULL]).test(e))return null;try{return new p(e,t)}catch(e){return null}}function p(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof p){if(e.loose===t.loose)return e;e=e.version}else if("string"!=typeof e)throw new TypeError("Invalid Version: "+e);if(e.length>256)throw new TypeError("version is longer than 256 characters");if(!(this instanceof p))return new p(e,t);r("SemVer",e,t),this.options=t,this.loose=!!t.loose;var n=e.trim().match(t.loose?o[u.LOOSE]:o[u.FULL]);if(!n)throw new TypeError("Invalid Version: "+e);if(this.raw=e,this.major=+n[1],this.minor=+n[2],this.patch=+n[3],this.major>a||this.major<0)throw new TypeError("Invalid major version");if(this.minor>a||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>a||this.patch<0)throw new TypeError("Invalid patch version");n[4]?this.prerelease=n[4].split(".").map((function(e){if(/^[0-9]+$/.test(e)){var t=+e;if(t>=0&&t<a)return t}return e})):this.prerelease=[],this.build=n[5]?n[5].split("."):[],this.format()}t.parse=f,t.valid=function(e,t){var n=f(e,t);return n?n.version:null},t.clean=function(e,t){var n=f(e.trim().replace(/^[=v]+/,""),t);return n?n.version:null},t.SemVer=p,p.prototype.format=function(){return this.version=this.major+"."+this.minor+"."+this.patch,this.prerelease.length&&(this.version+="-"+this.prerelease.join(".")),this.version},p.prototype.toString=function(){return this.version},p.prototype.compare=function(e){return r("SemVer.compare",this.version,this.options,e),e instanceof p||(e=new p(e,this.options)),this.compareMain(e)||this.comparePre(e)},p.prototype.compareMain=function(e){return e instanceof p||(e=new p(e,this.options)),m(this.major,e.major)||m(this.minor,e.minor)||m(this.patch,e.patch)},p.prototype.comparePre=function(e){if(e instanceof p||(e=new p(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;var t=0;do{var n=this.prerelease[t],a=e.prerelease[t];if(r("prerelease compare",t,n,a),void 0===n&&void 0===a)return 0;if(void 0===a)return 1;if(void 0===n)return-1;if(n!==a)return m(n,a)}while(++t)},p.prototype.compareBuild=function(e){e instanceof p||(e=new p(e,this.options));var t=0;do{var n=this.build[t],a=e.build[t];if(r("prerelease compare",t,n,a),void 0===n&&void 0===a)return 0;if(void 0===a)return 1;if(void 0===n)return-1;if(n!==a)return m(n,a)}while(++t)},p.prototype.inc=function(e,t){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t),this.inc("pre",t);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t),this.inc("pre",t);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":if(0===this.prerelease.length)this.prerelease=[0];else{for(var n=this.prerelease.length;--n>=0;)"number"==typeof this.prerelease[n]&&(this.prerelease[n]++,n=-2);-1===n&&this.prerelease.push(0)}t&&(this.prerelease[0]===t?isNaN(this.prerelease[1])&&(this.prerelease=[t,0]):this.prerelease=[t,0]);break;default:throw new Error("invalid increment argument: "+e)}return this.format(),this.raw=this.version,this},t.inc=function(e,t,n,r){"string"==typeof n&&(r=n,n=void 0);try{return new p(e,n).inc(t,r).version}catch(e){return null}},t.diff=function(e,t){if(b(e,t))return null;var n=f(e),r=f(t),a="";if(n.prerelease.length||r.prerelease.length){a="pre";var o="prerelease"}for(var i in n)if(("major"===i||"minor"===i||"patch"===i)&&n[i]!==r[i])return a+i;return o},t.compareIdentifiers=m;var d=/^[0-9]+$/;function m(e,t){var n=d.test(e),r=d.test(t);return n&&r&&(e=+e,t=+t),e===t?0:n&&!r?-1:r&&!n?1:e<t?-1:1}function v(e,t,n){return new p(e,n).compare(new p(t,n))}function h(e,t,n){return v(e,t,n)>0}function y(e,t,n){return v(e,t,n)<0}function b(e,t,n){return 0===v(e,t,n)}function g(e,t,n){return 0!==v(e,t,n)}function E(e,t,n){return v(e,t,n)>=0}function O(e,t,n){return v(e,t,n)<=0}function w(e,t,n,r){switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof n&&(n=n.version),e===n;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof n&&(n=n.version),e!==n;case"":case"=":case"==":return b(e,n,r);case"!=":return g(e,n,r);case">":return h(e,n,r);case">=":return E(e,n,r);case"<":return y(e,n,r);case"<=":return O(e,n,r);default:throw new TypeError("Invalid operator: "+t)}}function S(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof S){if(e.loose===!!t.loose)return e;e=e.value}if(!(this instanceof S))return new S(e,t);r("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===j?this.value="":this.value=this.operator+this.semver.version,r("comp",this)}t.rcompareIdentifiers=function(e,t){return m(t,e)},t.major=function(e,t){return new p(e,t).major},t.minor=function(e,t){return new p(e,t).minor},t.patch=function(e,t){return new p(e,t).patch},t.compare=v,t.compareLoose=function(e,t){return v(e,t,!0)},t.compareBuild=function(e,t,n){var r=new p(e,n),a=new p(t,n);return r.compare(a)||r.compareBuild(a)},t.rcompare=function(e,t,n){return v(t,e,n)},t.sort=function(e,n){return e.sort((function(e,r){return t.compareBuild(e,r,n)}))},t.rsort=function(e,n){return e.sort((function(e,r){return t.compareBuild(r,e,n)}))},t.gt=h,t.lt=y,t.eq=b,t.neq=g,t.gte=E,t.lte=O,t.cmp=w,t.Comparator=S;var j={};function C(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof C)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new C(e.raw,t);if(e instanceof S)return new C(e.value,t);if(!(this instanceof C))return new C(e,t);if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e,this.set=e.split(/\s*\|\|\s*/).map((function(e){return this.parseRange(e.trim())}),this).filter((function(e){return e.length})),!this.set.length)throw new TypeError("Invalid SemVer Range: "+e);this.format()}function A(e,t){for(var n=!0,r=e.slice(),a=r.pop();n&&r.length;)n=r.every((function(e){return a.intersects(e,t)})),a=r.pop();return n}function T(e){return!e||"x"===e.toLowerCase()||"*"===e}function I(e,t,n,r,a,o,i,u,l,s,c,f,p){return((t=T(n)?"":T(r)?">="+n+".0.0":T(a)?">="+n+"."+r+".0":">="+t)+" "+(u=T(l)?"":T(s)?"<"+(+l+1)+".0.0":T(c)?"<"+l+"."+(+s+1)+".0":f?"<="+l+"."+s+"."+c+"-"+f:"<="+u)).trim()}function x(e,t,n){for(var a=0;a<e.length;a++)if(!e[a].test(t))return!1;if(t.prerelease.length&&!n.includePrerelease){for(a=0;a<e.length;a++)if(r(e[a].semver),e[a].semver!==j&&e[a].semver.prerelease.length>0){var o=e[a].semver;if(o.major===t.major&&o.minor===t.minor&&o.patch===t.patch)return!0}return!1}return!0}function R(e,t,n){try{t=new C(t,n)}catch(e){return!1}return t.test(e)}function k(e,t,n,r){var a,o,i,u,l;switch(e=new p(e,r),t=new C(t,r),n){case">":a=h,o=O,i=y,u=">",l=">=";break;case"<":a=y,o=E,i=h,u="<",l="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(R(e,t,r))return!1;for(var s=0;s<t.set.length;++s){var c=t.set[s],f=null,d=null;if(c.forEach((function(e){e.semver===j&&(e=new S(">=0.0.0")),f=f||e,d=d||e,a(e.semver,f.semver,r)?f=e:i(e.semver,d.semver,r)&&(d=e)})),f.operator===u||f.operator===l)return!1;if((!d.operator||d.operator===u)&&o(e,d.semver))return!1;if(d.operator===l&&i(e,d.semver))return!1}return!0}S.prototype.parse=function(e){var t=this.options.loose?o[u.COMPARATORLOOSE]:o[u.COMPARATOR],n=e.match(t);if(!n)throw new TypeError("Invalid comparator: "+e);this.operator=void 0!==n[1]?n[1]:"","="===this.operator&&(this.operator=""),n[2]?this.semver=new p(n[2],this.options.loose):this.semver=j},S.prototype.toString=function(){return this.value},S.prototype.test=function(e){if(r("Comparator.test",e,this.options.loose),this.semver===j||e===j)return!0;if("string"==typeof e)try{e=new p(e,this.options)}catch(e){return!1}return w(e,this.operator,this.semver,this.options)},S.prototype.intersects=function(e,t){if(!(e instanceof S))throw new TypeError("a Comparator is required");var n;if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),""===this.operator)return""===this.value||(n=new C(e.value,t),R(this.value,n,t));if(""===e.operator)return""===e.value||(n=new C(this.value,t),R(e.semver,n,t));var r=!(">="!==this.operator&&">"!==this.operator||">="!==e.operator&&">"!==e.operator),a=!("<="!==this.operator&&"<"!==this.operator||"<="!==e.operator&&"<"!==e.operator),o=this.semver.version===e.semver.version,i=!(">="!==this.operator&&"<="!==this.operator||">="!==e.operator&&"<="!==e.operator),u=w(this.semver,"<",e.semver,t)&&(">="===this.operator||">"===this.operator)&&("<="===e.operator||"<"===e.operator),l=w(this.semver,">",e.semver,t)&&("<="===this.operator||"<"===this.operator)&&(">="===e.operator||">"===e.operator);return r||a||o&&i||u||l},t.Range=C,C.prototype.format=function(){return this.range=this.set.map((function(e){return e.join(" ").trim()})).join("||").trim(),this.range},C.prototype.toString=function(){return this.range},C.prototype.parseRange=function(e){var t=this.options.loose;e=e.trim();var n=t?o[u.HYPHENRANGELOOSE]:o[u.HYPHENRANGE];e=e.replace(n,I),r("hyphen replace",e),e=e.replace(o[u.COMPARATORTRIM],"$1$2$3"),r("comparator trim",e,o[u.COMPARATORTRIM]),e=(e=(e=e.replace(o[u.TILDETRIM],"$1~")).replace(o[u.CARETTRIM],"$1^")).split(/\s+/).join(" ");var a=t?o[u.COMPARATORLOOSE]:o[u.COMPARATOR],i=e.split(" ").map((function(e){return function(e,t){return r("comp",e,t),e=function(e,t){return e.trim().split(/\s+/).map((function(e){return function(e,t){r("caret",e,t);var n=t.loose?o[u.CARETLOOSE]:o[u.CARET];return e.replace(n,(function(t,n,a,o,i){var u;return r("caret",e,t,n,a,o,i),T(n)?u="":T(a)?u=">="+n+".0.0 <"+(+n+1)+".0.0":T(o)?u="0"===n?">="+n+"."+a+".0 <"+n+"."+(+a+1)+".0":">="+n+"."+a+".0 <"+(+n+1)+".0.0":i?(r("replaceCaret pr",i),u="0"===n?"0"===a?">="+n+"."+a+"."+o+"-"+i+" <"+n+"."+a+"."+(+o+1):">="+n+"."+a+"."+o+"-"+i+" <"+n+"."+(+a+1)+".0":">="+n+"."+a+"."+o+"-"+i+" <"+(+n+1)+".0.0"):(r("no pr"),u="0"===n?"0"===a?">="+n+"."+a+"."+o+" <"+n+"."+a+"."+(+o+1):">="+n+"."+a+"."+o+" <"+n+"."+(+a+1)+".0":">="+n+"."+a+"."+o+" <"+(+n+1)+".0.0"),r("caret return",u),u}))}(e,t)})).join(" ")}(e,t),r("caret",e),e=function(e,t){return e.trim().split(/\s+/).map((function(e){return function(e,t){var n=t.loose?o[u.TILDELOOSE]:o[u.TILDE];return e.replace(n,(function(t,n,a,o,i){var u;return r("tilde",e,t,n,a,o,i),T(n)?u="":T(a)?u=">="+n+".0.0 <"+(+n+1)+".0.0":T(o)?u=">="+n+"."+a+".0 <"+n+"."+(+a+1)+".0":i?(r("replaceTilde pr",i),u=">="+n+"."+a+"."+o+"-"+i+" <"+n+"."+(+a+1)+".0"):u=">="+n+"."+a+"."+o+" <"+n+"."+(+a+1)+".0",r("tilde return",u),u}))}(e,t)})).join(" ")}(e,t),r("tildes",e),e=function(e,t){return r("replaceXRanges",e,t),e.split(/\s+/).map((function(e){return function(e,t){e=e.trim();var n=t.loose?o[u.XRANGELOOSE]:o[u.XRANGE];return e.replace(n,(function(n,a,o,i,u,l){r("xRange",e,n,a,o,i,u,l);var s=T(o),c=s||T(i),f=c||T(u),p=f;return"="===a&&p&&(a=""),l=t.includePrerelease?"-0":"",s?n=">"===a||"<"===a?"<0.0.0-0":"*":a&&p?(c&&(i=0),u=0,">"===a?(a=">=",c?(o=+o+1,i=0,u=0):(i=+i+1,u=0)):"<="===a&&(a="<",c?o=+o+1:i=+i+1),n=a+o+"."+i+"."+u+l):c?n=">="+o+".0.0"+l+" <"+(+o+1)+".0.0"+l:f&&(n=">="+o+"."+i+".0"+l+" <"+o+"."+(+i+1)+".0"+l),r("xRange return",n),n}))}(e,t)})).join(" ")}(e,t),r("xrange",e),e=function(e,t){return r("replaceStars",e,t),e.trim().replace(o[u.STAR],"")}(e,t),r("stars",e),e}(e,this.options)}),this).join(" ").split(/\s+/);return this.options.loose&&(i=i.filter((function(e){return!!e.match(a)}))),i=i.map((function(e){return new S(e,this.options)}),this)},C.prototype.intersects=function(e,t){if(!(e instanceof C))throw new TypeError("a Range is required");return this.set.some((function(n){return A(n,t)&&e.set.some((function(e){return A(e,t)&&n.every((function(n){return e.every((function(e){return n.intersects(e,t)}))}))}))}))},t.toComparators=function(e,t){return new C(e,t).set.map((function(e){return e.map((function(e){return e.value})).join(" ").trim().split(" ")}))},C.prototype.test=function(e){if(!e)return!1;if("string"==typeof e)try{e=new p(e,this.options)}catch(e){return!1}for(var t=0;t<this.set.length;t++)if(x(this.set[t],e,this.options))return!0;return!1},t.satisfies=R,t.maxSatisfying=function(e,t,n){var r=null,a=null;try{var o=new C(t,n)}catch(e){return null}return e.forEach((function(e){o.test(e)&&(r&&-1!==a.compare(e)||(a=new p(r=e,n)))})),r},t.minSatisfying=function(e,t,n){var r=null,a=null;try{var o=new C(t,n)}catch(e){return null}return e.forEach((function(e){o.test(e)&&(r&&1!==a.compare(e)||(a=new p(r=e,n)))})),r},t.minVersion=function(e,t){e=new C(e,t);var n=new p("0.0.0");if(e.test(n))return n;if(n=new p("0.0.0-0"),e.test(n))return n;n=null;for(var r=0;r<e.set.length;++r){e.set[r].forEach((function(e){var t=new p(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":n&&!h(n,t)||(n=t);break;case"<":case"<=":break;default:throw new Error("Unexpected operation: "+e.operator)}}))}if(n&&e.test(n))return n;return null},t.validRange=function(e,t){try{return new C(e,t).range||"*"}catch(e){return null}},t.ltr=function(e,t,n){return k(e,t,"<",n)},t.gtr=function(e,t,n){return k(e,t,">",n)},t.outside=k,t.prerelease=function(e,t){var n=f(e,t);return n&&n.prerelease.length?n.prerelease:null},t.intersects=function(e,t,n){return e=new C(e,n),t=new C(t,n),e.intersects(t)},t.coerce=function(e,t){if(e instanceof p)return e;"number"==typeof e&&(e=String(e));if("string"!=typeof e)return null;var n=null;if((t=t||{}).rtl){for(var r;(r=o[u.COERCERTL].exec(e))&&(!n||n.index+n[0].length!==e.length);)n&&r.index+r[0].length===n.index+n[0].length||(n=r),o[u.COERCERTL].lastIndex=r.index+r[1].length+r[2].length;o[u.COERCERTL].lastIndex=-1}else n=e.match(o[u.COERCE]);if(null===n)return null;return f(n[2]+"."+(n[3]||"0")+"."+(n[4]||"0"),t)}}).call(this,n(11))},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var r=function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};Object.create;Object.create},,function(e,t,n){"use strict";function r(e){return"function"==typeof e?e():e}function a(){var e={};return e.promise=new Promise((function(t,n){e.resolve=t,e.reject=n})),e}e.exports=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=void 0,i=void 0,u=void 0,l=[];return function(){var c=r(t),f=(new Date).getTime(),p=!o||f-o>c;o=f;for(var d=arguments.length,m=Array(d),v=0;v<d;v++)m[v]=arguments[v];if(p&&n.leading)return n.accumulate?Promise.resolve(e.call(this,[m])).then((function(e){return e[0]})):Promise.resolve(e.call.apply(e,[this].concat(m)));if(i?clearTimeout(u):i=a(),l.push(m),u=setTimeout(s.bind(this),c),n.accumulate){var h=l.length-1;return i.promise.then((function(e){return e[h]}))}return i.promise};function s(){var t=i;clearTimeout(u),Promise.resolve(n.accumulate?e.call(this,l):e.apply(this,l[l.length-1])).then(t.resolve,t.reject),l=[],i=null}}},function(e){e.exports=JSON.parse('{"name":"grafana-azure-data-explorer-datasource","version":"4.1.0","description":"Grafana data source for Azure Data Explorer","scripts":{"build":"grafana-toolkit plugin:build","test":"jest --notify --watch","test:coverage":"jest --coverage","test:coverage:changes":"jest --coverage --changedSince=origin/main","dev":"grafana-toolkit plugin:dev","watch":"grafana-toolkit plugin:dev --watch","sign":"grafana-toolkit plugin:sign","e2e":"grafana-e2e run","e2e:open":"grafana-e2e open","e2e:update":"grafana-e2e run --update-screenshots"},"author":"Grafana Labs","license":"Apache","devDependencies":{"@emotion/core":"^11.0.0","@grafana/data":"8.5.2","@grafana/e2e":"8.5.2","@grafana/e2e-selectors":"8.5.2","@grafana/runtime":"8.5.2","@grafana/toolkit":"8.5.2","@grafana/ui":"8.5.2","@testing-library/react":"^11.2.5","@testing-library/user-event":"^13.1.9","@types/chance":"^1.1.2","@types/debounce-promise":"^3.1.2","@types/grafana":"github:CorpGlory/types-grafana.git","@types/lodash":"^4.14.158","@typescript-eslint/eslint-plugin":"3.6.0","@typescript-eslint/parser":"3.6.0","chance":"^1.1.7","cypress":"9.3.1","emotion":"^11.0.0","jest-environment-jsdom-sixteen":"^1.0.3","monaco-editor":"0.17.0","ts-jest":"^26.4.3"},"dependencies":{"@testing-library/jest-dom":"^5.16.1","debounce-promise":"^3.1.2","react-select-event":"^5.2.0","react-use":"^15.3.3","tslib":"^2.3.1"},"resolutions":{"rxjs":"6.6.3"}}')},function(e,t){var n,r,a=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function u(e){if(n===setTimeout)return setTimeout(e,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(e){n=o}try{r="function"==typeof clearTimeout?clearTimeout:i}catch(e){r=i}}();var l,s=[],c=!1,f=-1;function p(){c&&l&&(c=!1,l.length?s=l.concat(s):f=-1,s.length&&d())}function d(){if(!c){var e=u(p);c=!0;for(var t=s.length;t;){for(l=s,s=[];++f<t;)l&&l[f].run();f=-1,t=s.length}l=null,c=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===i||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function m(e,t){this.fun=e,this.array=t}function v(){}a.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];s.push(new m(e,t)),1!==s.length||c||u(d)},m.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=v,a.addListener=v,a.once=v,a.off=v,a.removeListener=v,a.removeAllListeners=v,a.emit=v,a.prependListener=v,a.prependOnceListener=v,a.listeners=function(e){return[]},a.binding=function(e){throw new Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(e){throw new Error("process.chdir is not supported")},a.umask=function(){return 0}},function(e,t,n){"use strict";n.r(t);var r=n(5);function a(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(r=Object.getOwnPropertySymbols(e);a<r.length;a++)t.indexOf(r[a])<0&&Object.prototype.propertyIsEnumerable.call(e,r[a])&&(n[r[a]]=e[r[a]])}return n}function o(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{l(r.next(e))}catch(e){o(e)}}function u(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,u)}l((r=r.apply(e,t||[])).next())}))}Object.create;Object.create;var i,u=n(0),l=n.n(u),s=n(3),c=function(){return l.a.createElement("div",{className:"gf-form-group"},l.a.createElement("div",{className:"grafana-info-box"},l.a.createElement("h5",null,"Configuring Azure and your Azure Data Explorer Database"),l.a.createElement("h5",null,"1. Create an AAD application"),l.a.createElement("p",null,"Details on how to do create one via the Azure portal or with the Azure CLI can be found"," ",l.a.createElement("a",{className:"external-link",target:"_blank",rel:"noreferrer",href:"https://github.com/grafana/azure-data-explorer-datasource#configuring-the-datasource-in-grafana"},"here.")),l.a.createElement("h5",null,"2. Connect the AAD Application to a database user"),l.a.createElement("p",null,"Navigate to the Azure Data Explorer Web UI via the Azure Portal. The AAD application that you created in step 1 needs to be given viewer access to your Azure Data Explorer database. This is done using the dot command"," ",l.a.createElement("i",null,"add"),":"),l.a.createElement("pre",null,".add database your_db_name viewers (â€˜aadapp=your_client_id;your_tenant_idâ€™)"),l.a.createElement("h5",null,"3. Configure the connection in Grafana"),l.a.createElement("p",null,"Use the details from the AAD Service Principle from Step 1 to fill in the field below. Then click the Save & Test button."),l.a.createElement("p",null,"Detailed instructions on all three steps can found in"," ",l.a.createElement("a",{className:"external-link",target:"_blank",rel:"noreferrer",href:"https://github.com/grafana/azure-data-explorer-datasource#configuring-the-datasource-in-grafana"},"in the documentation."))))},f=n(1);!function(e){e.Property="property",e.Operator="operator",e.Reduce="reduce",e.FunctionParameter="functionParameter",e.GroupBy="groupBy",e.Or="or",e.And="and"}(i||(i={}));var p,d=n(10);!function(e){e.Visual="visual",e.Raw="raw"}(p||(p={}));var m,v,h={query:"",querySource:p.Raw,expression:{where:{type:i.And,expressions:[]},groupBy:{type:i.And,expressions:[]},reduce:{type:i.And,expressions:[]}},pluginVersion:d.version};!function(e){e.function="function",e.table="table",e.materializedView="materializedView"}(m||(m={})),function(e){e.AzurePublic="azuremonitor",e.AzureUSGovernment="govazuremonitor",e.AzureChina="chinaazuremonitor"}(v||(v={}));var y={configEditor:{azureCloud:{input:"data-testid azure-cloud"},tenantID:{input:"data-testid tenant-id"},clusterURL:{input:"data-testid cluster-url"},clientID:{input:"data-testid client-id"},clientSecret:{input:"data-testid client-secret"}},queryEditor:{editKQL:{button:"Edit KQL"},codeEditorLegacy:{container:"data-testid legacy-editor",textarea:"Editor content;Press Alt+F1 for Accessibility Options."},codeEditor:{container:"data-testid code-editor"},database:{input:"Database"},tableFrom:{input:"From table"},runQuery:{button:"Run Query"}}},b=f.LegacyForms.SecretFormField,g=[{value:v.AzurePublic,label:"Azure"},{value:v.AzureUSGovernment,label:"Azure US Government"},{value:v.AzureChina,label:"Azure China"}],E=function(e){var t=e.options,n=e.onOptionsChange,r=e.updateJsonData,a=e.handleClearClientSecret,o=t.jsonData,i=t.secureJsonData,c=t.secureJsonFields;Object(u.useEffect)((function(){o.onBehalfOf&&!s.config.featureToggles.adxOnBehalfOf&&r("onBehalfOf",!1),o.azureCloud||r("azureCloud",v.AzurePublic),!!o.oauthPassThru!=!!o.onBehalfOf&&r("oauthPassThru",!!o.onBehalfOf)}),[o.azureCloud,o.oauthPassThru,o.onBehalfOf,r]);var p=l.a.createElement(l.a.Fragment,null,"To create a new key, log in to Azure Portal, navigate to Azure Active Directory ","ðŸ¡’"," App Registrations"," ðŸ¡’ "," Choose your app ","ðŸ¡’"," Keys.",l.a.createElement("br",null),l.a.createElement("br",null),l.a.createElement("a",{target:"_blank",rel:"noreferrer",href:"https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-create-service-principal-portal"},"Click here for detailed instructions on setting up an Azure Active Directory (AD) application."));return l.a.createElement(f.FieldSet,{label:"Connection Details"},l.a.createElement(f.InlineField,{label:"Azure cloud",labelWidth:26,tooltip:"Select an Azure Cloud.",required:!0,"data-testid":y.configEditor.azureCloud.input,htmlFor:"azure-cloud-type"},l.a.createElement(f.Select,{inputId:"azure-cloud-type",options:g,value:g.find((function(e){return e.value===o.azureCloud})),onChange:function(e){return r("azureCloud",e.value?e.value:v.AzurePublic)},isClearable:!1,width:60})),l.a.createElement(f.InlineField,{label:"Cluster URL",labelWidth:26,tooltip:"The cluster url for your Azure Data Explorer database."},l.a.createElement(f.Input,{"data-testid":y.configEditor.clusterURL.input,value:o.clusterUrl,id:"adx-cluster-url",placeholder:"https://yourcluster.kusto.windows.net",width:60,onChange:function(e){return r("clusterUrl",e.target.value)}})),l.a.createElement(f.InlineField,{label:"Tenant ID",labelWidth:26,tooltip:l.a.createElement(l.a.Fragment,null,"In the Azure Portal, navigate to Azure Active Directory ","ðŸ¡’"," Properties ","ðŸ¡’"," Directory ID.",l.a.createElement("br",null),l.a.createElement("br",null),l.a.createElement("a",{target:"_blank",rel:"noreferrer",href:"https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-create-service-principal-portal"},"Click here for detailed instructions on setting up an Azure Active Directory (AD) application."))},l.a.createElement(f.Input,{value:o.tenantId,id:"adx-tenant-id","data-testid":y.configEditor.tenantID.input,width:60,onChange:function(e){return r("tenantId",e.target.value)}})),l.a.createElement(f.InlineField,{label:"Client ID",labelWidth:26,tooltip:l.a.createElement(l.a.Fragment,null,"In the Azure Portal, navigate to Azure Active Directory ","ðŸ¡’"," App Registrations ","ðŸ¡’"," Choose your app ","ðŸ¡’","Application ID.",l.a.createElement("br",null),l.a.createElement("br",null),l.a.createElement("a",{target:"_blank",rel:"noreferrer",href:"https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-create-service-principal-portal"},"Click here for detailed instructions on setting up an Azure Active Directory (AD) application."))},l.a.createElement(f.Input,{value:o.clientId,id:"adx-client-id","data-testid":y.configEditor.clientID.input,width:60,onChange:function(e){return r("clientId",e.target.value)}})),l.a.createElement(b,{label:"Client secret","aria-label":"Client secret","data-testid":y.configEditor.clientSecret.input,value:(null==i?void 0:i.clientSecret)||void 0,labelWidth:13,inputWidth:30,placeholder:"",onReset:function(){return a()},onChange:function(e){n(Object.assign(Object.assign({},t),{secureJsonData:Object.assign(Object.assign({},i),{clientSecret:!!e&&e.target.value})}))},isConfigured:!!(null==c?void 0:c.clientSecret),tooltip:p}),s.config.featureToggles.adxOnBehalfOf&&l.a.createElement(f.InlineField,{label:"Use On-Behalf-Of",htmlFor:"adx-on-behalf-of",labelWidth:26,tooltip:l.a.createElement(l.a.Fragment,null,"Propagate Grafana client credentials to ADX with a token exchange. When enabled the service account (Client ID) impersonates the user by augmenting the access token. See the"," ",l.a.createElement("a",{target:"_blank",rel:"noreferrer",href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow"},"developer documentation")," ","for detail on the concept. This feature requires a Grafana version 8.3.4 or later.")},l.a.createElement(f.HorizontalGroup,null,l.a.createElement(f.InlineSwitch,{id:"adx-on-behalf-of",value:o.onBehalfOf,onChange:function(e){return r("onBehalfOf",e.target.checked)}}),l.a.createElement("span",null,"âš ï¸ This feature is in beta"))))};function O(e){return function(e){if(Array.isArray(e))return w(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return w(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return w(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function S(e){var t;switch(null==e?void 0:e.type){case"function":var n=null!==(t=e.input)&&void 0!==t?t:[];return"".concat(e.value,"(").concat(n.map((function(e){return e.Value})).join(","),")");default:return e.value}}var j=function(e){var t=e.options,n=e.schema,r=e.updateJsonData,a=e.onRefresh,o=t.jsonData,i=Object(u.useMemo)((function(){var e;return null!==(e=o.schemaMappings)&&void 0!==e?e:[]}),[o.schemaMappings]),s=Object(u.useCallback)((function(){r("schemaMappings",[].concat(O(i),[{}]))}),[i,r]);return l.a.createElement(f.FieldSet,{label:"Database schema settings"},l.a.createElement(f.InlineField,{label:"Default database",labelWidth:26},l.a.createElement(f.Select,{width:45,options:n.databases,value:n.databases.find((function(e){return e.value===o.defaultDatabase})),onChange:function(e){return r("defaultDatabase",e.value||"")}})),l.a.createElement(f.InlineField,{label:"Use managed schema",labelWidth:26},l.a.createElement(f.InlineSwitch,{id:"adx-use-schema-mapping",value:o.useSchemaMapping,onChange:function(e){return r("useSchemaMapping",e.target.checked)}})),o.useSchemaMapping&&l.a.createElement(f.InlineField,{label:"Schema mappings",labelWidth:26},l.a.createElement(f.VerticalGroup,{spacing:"xs"},i.map((function(e,t){return l.a.createElement(f.HorizontalGroup,{spacing:"xs",key:t},l.a.createElement(f.Select,{value:n.schemaMappingOptions.find((function(t){return t.value===e.value})),options:n.schemaMappingOptions,onChange:function(e){return function(e,t){var a,o=t.value&&(null===(a=n.schemaMappingOptions)||void 0===a?void 0:a.find((function(e){return e.value===t.value})));if(o){var u=O(i);u[e]=Object.assign(Object.assign({},u[e]),{database:o.database,type:o.type,name:o.value,value:S(o)}),r("schemaMappings",u)}}(t,e)},width:38,placeholder:"Target"}),l.a.createElement(f.InlineLabel,null,l.a.createElement(f.Icon,{name:"arrow-right"})),l.a.createElement(f.Input,{placeholder:"Name",value:e.displayName,onChange:function(e){return function(e,t){var n=O(i);n[e]=Object.assign(Object.assign({},n[e]),{displayName:t}),r("schemaMappings",n)}(t,e.target.value)}}),l.a.createElement(f.Button,{variant:"secondary",size:"md",icon:"trash-alt","aria-label":"Remove",type:"button",onClick:function(){return function(e){var t=O(i);t.splice(e,1),r("schemaMappings",t)}(t)}}))})),l.a.createElement(f.Button,{variant:"secondary",size:"md",onClick:s,type:"button"},"Add mapping"))),l.a.createElement("br",null),l.a.createElement(f.Button,{variant:"primary",onClick:a,type:"button",icon:"sync"},"Reload schema"))},C=[{value:"strongconsistency",label:"Strong"},{value:"weakconsistency",label:"Weak"}],A=[{value:p.Visual,label:"Visual"},{value:p.Raw,label:"Raw"}],T=function(e){var t=e.options,n=e.updateJsonData,r=t.jsonData;return Object(u.useEffect)((function(){r.dataConsistency||n("dataConsistency",C[0].value),r.defaultEditorMode||n("defaultEditorMode",A[0].value)}),[r.dataConsistency,r.defaultEditorMode,n]),l.a.createElement(f.FieldSet,{label:"Query Optimizations"},l.a.createElement(f.InlineField,{label:"Query timeout",labelWidth:26,tooltip:"This value controls the client query timeout."},l.a.createElement(f.Input,{value:r.queryTimeout,id:"adx-query-timeout",placeholder:"30s",width:18,onChange:function(e){return n("queryTimeout",e.target.value)}})),l.a.createElement(f.InlineField,{label:"Use dynamic caching",labelWidth:26,tooltip:"By enabling this feature Grafana will dynamically apply cache settings on a per query basis and the default cache max age will be ignored.<br /><br />For time series queries we will use the bin size to widen the time range but also as cache max age."},l.a.createElement(f.InlineSwitch,{value:r.dynamicCaching,id:"adx-caching",transparent:!1,onChange:function(e){return n("dynamicCaching",e.target.checked)}})),l.a.createElement(f.InlineField,{label:"Cache max age",labelWidth:26,tooltip:"By default the cache is disabled. If you want to enable the query caching please specify a max timespan for the cache to live."},l.a.createElement(f.Input,{value:r.cacheMaxAge,id:"adx-cache-age",placeholder:"0m",width:18,onChange:function(e){return n("cacheMaxAge",e.target.value)}})),l.a.createElement(f.InlineField,{label:"Data consistency",labelWidth:26,tooltip:"Defaults to Strong"},l.a.createElement(f.Select,{options:C,value:C.find((function(e){return e.value===r.dataConsistency})),onChange:function(e){return n("dataConsistency",e.value?e.value:C[0].value)},isClearable:!1,width:18})),l.a.createElement(f.InlineField,{label:"Default editor mode",labelWidth:26,tooltip:"Defaults to Visual"},l.a.createElement(f.Select,{options:A,value:A.find((function(e){return e.value===r.defaultEditorMode})),onChange:function(e){return n("defaultEditorMode",e.value||p.Visual)},width:18})))};function I(e){return o(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n,r,a,o,i,u,l,s,c,f,p,d,v,h,y;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=[],r=[],t.next=4,e.getSchema();case 4:for(a=t.sent,o=0,i=Object.values(a.Databases);o<i.length;o++){for(u=i[o],n.push({label:u.Name,value:u.Name}),l=0,s=Object.values(u.Tables);l<s.length;l++)c=s[l],r.push({type:m.table,label:"".concat(u.Name,"/tables/").concat(c.Name),value:c.Name,name:c.Name,database:u.Name});for(f=0,p=Object.values(u.Functions);f<p.length;f++)d=p[f],r.push({type:m.function,label:"".concat(u.Name,"/functions/").concat(d.Name),value:d.Name,name:d.Name,input:d.InputParameters,database:u.Name});for(v=0,h=Object.values(u.MaterializedViews);v<h.length;v++)y=h[v],r.push({type:m.materializedView,label:"".concat(u.Name,"/materializedViews/").concat(y.Name),value:y.Name,name:y.Name,database:u.Name})}return t.abrupt("return",{databases:n,schemaMappingOptions:r});case 7:case"end":return t.stop()}}),t)})))}var x=function(e){var t=e.options,n=e.updateJsonData,r=t.jsonData;return l.a.createElement(f.FieldSet,{label:"Tracking"},l.a.createElement(f.InlineField,{label:"Send username header to host",labelWidth:26,tooltip:l.a.createElement("p",null,"With this feature enabled, Grafana will pass the logged in user's username in the"," ",l.a.createElement("code",null,"x-ms-user-id")," header and in the ",l.a.createElement("code",null,"x-ms-client-request-id")," header when sending requests to ADX. Can be useful when tracking needs to be done in ADX."," ")},l.a.createElement(f.InlineSwitch,{id:"adx-username-header",value:r.enableUserTracking,onChange:function(e){return n("enableUserTracking",e.target.checked)}})))};function R(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function k(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,a,o=[],i=!0,u=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(e){u=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(u)throw a}}return o}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return N(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return N(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function N(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var D,F=function(e){var t=e.options,n=e.onOptionsChange,r=k(Object(u.useState)({databases:[],schemaMappingOptions:[]}),2),a=r[0],i=r[1],p=k(Object(u.useState)(),2),d=p[0],m=p[1],v=t.jsonData,h=Object(u.useCallback)((function(){return o(void 0,void 0,void 0,regeneratorRuntime.mark((function e(){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(s.getDataSourceSrv)().get(t.name);case 2:return n=e.sent,e.abrupt("return",n);case 4:case"end":return e.stop()}}),e)})))}),[t.name]),y=Object(u.useCallback)((function(){return o(void 0,void 0,void 0,regeneratorRuntime.mark((function e(){var n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.secureJsonFields&&0!==Object.keys(t.secureJsonFields).length){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,h();case 5:return n=e.sent,e.next=8,I(n);case 8:if(r=e.sent){e.next=11;break}return e.abrupt("return");case 11:i(r),m(void 0),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(2),m(e.t0.data);case 18:case"end":return e.stop()}}),e,null,[[2,15]])})))}),[h,t.secureJsonFields]),b=Object(u.useCallback)((function(e,r){n(Object.assign(Object.assign({},t),{jsonData:Object.assign(Object.assign({},v),R({},e,r))}))}),[v,n,t]);Object(u.useEffect)((function(){t.id&&y()}),[t.id,y]),Object(u.useEffect)((function(){!v.defaultDatabase&&(null==a?void 0:a.databases.length)&&b("defaultDatabase",null==a?void 0:a.databases[0].value)}),[null==a?void 0:a.databases,v.defaultDatabase,b]);var g=Object(u.useCallback)((function(){n(Object.assign(Object.assign({},t),{secureJsonData:Object.assign(Object.assign({},t.secureJsonData),{clientSecret:!1}),secureJsonFields:Object.assign(Object.assign({},t.secureJsonFields),{clientSecret:!1})}))}),[n,t]);return l.a.createElement("div",{"data-testid":"azure-data-explorer-config-editor"},l.a.createElement(c,null),l.a.createElement(E,{options:t,onOptionsChange:n,updateJsonData:b,handleClearClientSecret:g}),l.a.createElement(T,{options:t,onOptionsChange:n,updateJsonData:b}),l.a.createElement(j,{schema:a,options:t,onOptionsChange:n,updateJsonData:b,onRefresh:y}),l.a.createElement(x,{options:t,onOptionsChange:n,updateJsonData:b}),d&&l.a.createElement(f.Alert,{severity:"error",title:"Error updating Azure Data Explorer schema"},d.message))};function P(e){var t=[],n=e.fields.find((function(e){return e.type===r.FieldType.string}));if(n)for(var a=0;a<n.values.length;a++)t.push({text:n.values.get(a)});return t}!function(e){e.Number="number",e.String="string",e.Boolean="boolean",e.DateTime="dateTime",e.TimeSpan="timeSpan",e.Function="function",e.Interval="interval"}(D||(D={}));var L=function(e){return(null==e?void 0:e.type)===i.Reduce},M=function(e){return(null==e?void 0:e.type)===i.Property},_=function(e){return(null==e?void 0:e.type)===i.Operator},V=function(e){return(null==e?void 0:e.type)===i.GroupBy},z=function(e){return Array.isArray(null==e?void 0:e.value)},$=function(e){return(null==e?void 0:e.type)===i.And},B=function(e){return(null==e?void 0:e.type)===i.Or},q=function(e){return $(e)||B(e)},U=n(4),G=n.n(U);function W(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return X(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return X(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,u=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){u=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(u)throw o}}}}function X(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Q(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function H(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var K=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(s.getTemplateSrv)();Q(this,e),this.templateSrv=t}var t,n,r;return t=e,(n=[{key:"toAutoCompleteQuery",value:function(e,t){if(!(null==e?void 0:e.expression)||!e.expression.from||!e.search.property)return"";var n={timeColumn:Z(t,null==e?void 0:e.expression),castIfDynamic:function(e,n){return ee(e,t,n)}},r=[];this.appendProperty(n,e.expression.from,r),this.appendTimeFilter(n,void 0,r);var a=ne(e.index,e.expression.where,e.search),o=e.search.property.name;return this.appendWhere(n,a,r,"where"),r.push("take 50000"),r.push("distinct ".concat(n.castIfDynamic(o))),r.push("take 251"),r.join("\n| ")}},{key:"toQuery",value:function(e,t){if(!e||!e.from)return"";var n={timeColumn:Z(t,e),castIfDynamic:function(e,n){return ee(e,t,n)}},r=[];return this.appendProperty(n,e.from,r),this.appendTimeFilter(n,e.timeshift,r),this.appendWhere(n,null==e?void 0:e.where,r,"where"),this.appendTimeshift(n,e.timeshift,r),this.appendSummarize(n,e.reduce,e.groupBy,r),this.appendOrderBy(n,e.groupBy,e.reduce,r),0===r.length?"":r.join("\n| ")}},{key:"appendTimeshift",value:function(e,t,n){var r=re(e,t);r&&n.push("extend ".concat(e.timeColumn," = ").concat(e.timeColumn," + ").concat(r))}},{key:"appendTimeFilter",value:function(e,t,n){if(e.timeColumn){var r=re(e,t);r?n.push("where ".concat(e.timeColumn," between (($__timeFrom - ").concat(r,") .. ($__timeTo - ").concat(r,"))")):Y(e.timeColumn)?n.push("where ".concat(e.timeColumn," between ($__timeFrom .. $__timeTo)")):n.push("where $__timeFilter(".concat(e.timeColumn,")"))}}},{key:"appendOrderBy",value:function(e,t,n,r){if(e.timeColumn){var a=Array.isArray(t.expressions)&&0===t.expressions.length,o=Array.isArray(n.expressions)&&0===n.expressions.length;(a&&o||t.expressions.find((function(e){return!(!V(e)||!e.interval)})))&&r.push("order by ".concat(e.timeColumn," asc"))}}},{key:"appendWhere",value:function(e,t,n,r,a){var o=this;if(t){var i=a||[];if($(t))return t.expressions.forEach((function(t){return o.appendWhere(e,t,n,r,i)}));if(B(t)){var u=[];if(t.expressions.map((function(t){return o.appendWhere(e,t,u,void 0,i)})),0===u.length)return;this.appendMvExpand(i,n),n.push("where ".concat(u.join(" or "))),this.appendProjectAway(i,n)}return _(t)?this.appendOperator(t,n,i,r):void 0}}},{key:"appendSummarize",value:function(e,t,n,r){var a,o,i,u=this,l=!1,s=[],c=[],f=[],p=[],d=W(null!==(a=null==t?void 0:t.expressions)&&void 0!==a?a:[]);try{for(d.s();!(i=d.n()).done;){var m=i.value;if(L(m)){var v=m.reduce.name,h=m.parameters,y=this.addExpanPartsdIfNeeded(m.property.name,f),b=e.castIfDynamic(y,m.property.name);if(p.push(b),Array.isArray(h)){var g=h.map((function(e){return u.formatValue(e.value,e.fieldType)})).join(", ");s.push("".concat(v,"(").concat(b,", ").concat(g,")"))}else"count"!==v?"none"===v||s.push("".concat(v,"(").concat(b,")")):l||(l=!0,s.push("count()"))}}}catch(e){d.e(e)}finally{d.f()}var E,O=W(null!==(o=null==n?void 0:n.expressions)&&void 0!==o?o:[]);try{for(O.s();!(E=O.n()).done;){var w=E.value;if(V(w)){var S=this.addExpanPartsdIfNeeded(w.property.name,f),j=e.castIfDynamic(S,w.property.name);if(w.interval){var C=w.interval.name;c.unshift("bin(".concat(j,", ").concat(C,")"))}else c.push(j)}}}catch(e){O.e(e)}finally{O.f()}if(this.appendMvExpand(f,r),s.length>0)return c.length>0?void r.push("summarize ".concat(s.join(", ")," by ").concat(c.join(", "))):void r.push("summarize ".concat(s.join(", ")));c.length>0?r.push("summarize by ".concat(c.join(", "))):p.length>0&&r.push("project ".concat(p.join(", ")))}},{key:"appendOperator",value:function(e,t,n,r){var a=e.property,o=e.operator;if(a.name&&o.name)switch(o.name){case"isnotempty":t.push(J("".concat(o.name,"(").concat(a.name,")"),r));break;default:var i=this.formatValue(o.value,a.type),u=this.addExpanPartsdIfNeeded(a.name,n);t.push(J("".concat(u," ").concat(o.name," ").concat(i),r))}}},{key:"formatValue",value:function(e,t){var n=this;if(Array.isArray(e))return"(".concat(e.map((function(e){return n.formatValue(e,t)})).join(", "),")");if(this.isTemplateVariable(e))return e;switch(t){case D.Number:case D.Boolean:return e;default:return"'".concat(e,"'")}}},{key:"addExpanPartsdIfNeeded",value:function(e,t){if(e.includes('["`indexer`"]')){var n=e.split('["`indexer`"]'),r=t.push(n[0]),a=e.replace("".concat(t[r-1]).concat('["`indexer`"]'),"array_".concat(r));return a.includes('["`indexer`"]')?this.addExpanPartsdIfNeeded(a,t):a}return e}},{key:"appendMvExpand",value:function(e,t){e.forEach((function(e,n){return t.push("mv-expand array_".concat(n+1," = ").concat(e))}))}},{key:"appendProjectAway",value:function(e,t){if(e.length){var n=e.map((function(e,t){return"array_".concat(t+1)}));t.push("project-away ".concat(n.join(", ")))}}},{key:"appendProperty",value:function(e,t,n){n.push(this.formatProperty(t.property.name))}},{key:"formatProperty",value:function(e){return/[\s\.-]/.test(e)&&!/[\$\(]/.test(e)?"['".concat(e,"']"):e}},{key:"isTemplateVariable",value:function(e){return!!Array.isArray(this.templateSrv.getVariables())&&!!this.templateSrv.getVariables().find((function(t){return"$".concat(null==t?void 0:t.id)===e}))}}])&&H(t.prototype,n),r&&H(t,r),e}(),J=function(e,t){return t?"".concat(t," ").concat(e):e},Z=function(e,t){if(Array.isArray(null==t?void 0:t.groupBy.expressions)){var n=null==t?void 0:t.groupBy.expressions.find((function(e){return!!V(e)&&(e.property.type===D.DateTime&&e.interval)}));if(V(n))return ee(n.property.name,e)}if(Array.isArray(e)){var r=null==e?void 0:e.find((function(e){return"datetime"===e.CslType&&-1===e.Name.indexOf("[")}));if(r)return null==r?void 0:r.Name;var a=null==e?void 0:e.find((function(e){return"datetime"===e.CslType}));return a?te(a.CslType,a.Name):a}},Y=function(e){return!!(e&&e.indexOf("[")>-1)||!!(e&&e.indexOf("todynamic")>-1)},ee=function(e,t,n){if(!Y(n||e)||!Array.isArray(t))return e;var r=t.find((function(t){return t.Name===(n||e)}));return r?te(r.CslType,e):e},te=function(e,t){return"to".concat(e,"(").concat(t,")")},ne=function(e,t,n){for(var r=e.split("-").map((function(e){return parseInt(e,10)})),a=Object(U.cloneDeep)(t),o=a.expressions,i=0;i<r.length;i++){var u=r[i];if(i===r.length-1){o[u]=n;break}if(Array.isArray(o)){var l=o[u];if(q(l)){o=l.expressions;continue}}}return a},re=function(e,t){if(!t||!e.timeColumn||!t.property)return null;var n=t.property.name;return/^(\d{1,15}(?:d|h|ms|s|m){0,1})$/gm.test(n)?n:null},ae=function(e){return{value:e.Name,label:e.Name,type:D.String}},oe=function(e){switch(e){case"real":case"int":case"long":return D.Number;case"datetime":return D.DateTime;case"bool":return D.Boolean;case"timespan":return D.TimeSpan;default:return D.String}};function ie(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return ue(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ue(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,u=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){u=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(u)throw o}}}}function ue(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function le(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function se(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ce=function(e){return Object.values(e).every((function(e){return void 0!==e}))&&!!e.database&&!!e.displayName&&!!e.name&&!!e.type&&!!e.value},fe=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];le(this,e),this.enabled=t,this.mappingsByDatabase={},this.displayNameToMapping={},this.nameToMapping={},this.valueToMapping={};var r,a=ie(n);try{for(a.s();!(r=a.n()).done;){var o=r.value;ce(o)&&(Array.isArray(this.mappingsByDatabase[o.database])||(this.mappingsByDatabase[o.database]=[]),this.mappingsByDatabase[o.database].push(o),this.displayNameToMapping[o.displayName]=o,this.nameToMapping[o.name]=o,this.valueToMapping[o.value]=o)}}catch(e){a.e(e)}finally{a.f()}}var t,n,r;return t=e,(n=[{key:"getMappingByValue",value:function(e){if(this.enabled&&e)return this.valueToMapping[e]}},{key:"getTableOptions",value:function(e,t){var n=e.Databases[t];if(!n||!n.Tables)return[];if(!this.enabled)return Object.keys(n.Tables).map((function(e){return function(e){return{label:e.Name,value:e.Name,type:D.String}}(n.Tables[e])}));var r=this.mappingsByDatabase[t];return pe(n,r)}}])&&se(t.prototype,n),r&&se(t,r),e}(),pe=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return t.reduce((function(t,n){return n.type===m.table&&e.Tables[n.name]||n.type===m.materializedView&&e.MaterializedViews[n.name]||n.type===m.function&&e.Functions[n.name]?(t.push(de(n)),t):t}),[])},de=function(e){return{type:D.String,label:e.displayName,value:e.value}},me={},ve=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return o(void 0,void 0,void 0,regeneratorRuntime.mark((function r(){var a;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(me[e]&&!n){r.next=5;break}return r.next=3,t();case 3:a=r.sent,me[e]=a;case 5:return r.abrupt("return",me[e]);case 6:case"end":return r.stop()}}),r)})))},he=function(e){var t,n,r,a,o;if(e.target&&null!==e.target.database)return e;var i=Object.assign(Object.assign(Object.assign({},h),null!==(t=e.target)&&void 0!==t?t:{}),{database:e.database,query:null!==(n=e.query)&&void 0!==n?n:"",rawMode:!0,refId:null!==(a=null===(r=e.target)||void 0===r?void 0:r.refId)&&void 0!==a?a:"Anno",resultFormat:null!==(o=e.resultFormat)&&void 0!==o?o:"table",pluginVersion:h.pluginVersion});return Object.assign(Object.assign({},e),{target:i})};function ye(e,t){if(!e)return"";return(e=(e=e.replace(/\$__([_a-zA-Z0-9]+)\(([^\)]*)\)/gi,(function(e,t,n){return"contains"===t?function(e){var t=e.indexOf(","),n=e.substring(0,t),r=e.substring(e.indexOf(",")+1);if(r&&"all"===r.toLowerCase().trim())return"1 == 1";return"".concat(n.trim()," in (").concat(be(r.trim()),")")}(n):e}))).replace(/\$(__interval|__interval_ms)/gi,(function(e,n){var r;if(!t)return e;var a=t[n];return null!==(r=null==a?void 0:a.value)&&void 0!==r?r:e}))).replace(/\$__escapeMulti\(('[^]*')\)/gi,(function(e,t){return(n=t).substring(1,n.length-1).split("','").map((function(e){return"@'".concat(e,"'")})).join(", ");var n}))}function be(e){return e.match(/,+/i)?e.split(",").map(be).join(","):e.match(/^'(.*)'$/i)?e:"'".concat(e,"'")}function ge(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Ee(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ee(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,u=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){u=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(u)throw o}}}}function Ee(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Oe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var we=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,(n=[{key:"parseDatabases",value:function(e){var t=[];if(!e)return t;var n,r=ge(e.Tables);try{for(r.s();!(n=r.n()).done;){var a,o=ge(n.value.Rows);try{for(o.s();!(a=o.n()).done;){var i=a.value;t.push({text:i[5]||i[0],value:i[0]})}}catch(e){o.e(e)}finally{o.f()}}}catch(e){r.e(e)}finally{r.f()}return t}},{key:"parseSchemaResult",value:function(e){var t=e.Tables[0].Rows[0][0];return JSON.parse(t)}}])&&Oe(t.prototype,n),r&&Oe(t,r),e}();function Se(e){return(Se="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function je(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Ce(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ce(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,u=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){u=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(u)throw o}}}}function Ce(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Ae(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Te(){return(Te="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=Ie(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(arguments.length<3?e:n):a.value}}).apply(this,arguments)}function Ie(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=De(e)););return e}function xe(e,t){return(xe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Re(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=De(e);if(t){var a=De(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return ke(this,n)}}function ke(e,t){if(t&&("object"===Se(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return Ne(e)}function Ne(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function De(e){return(De=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Fe,Pe,Le,Me,_e=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&xe(e,t)}(i,e);var t,n,r,a=Re(i);function i(e){var t,n,r,o;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),(t=a.call(this,e)).annotations={prepareAnnotation:he};var u=null!==(n=e.jsonData.useSchemaMapping)&&void 0!==n&&n,l=null!==(r=e.jsonData.schemaMappings)&&void 0!==r?r:[];return t.backendSrv=Object(s.getBackendSrv)(),t.templateSrv=Object(s.getTemplateSrv)(),t.defaultOrFirstDatabase=e.jsonData.defaultDatabase,t.url=e.url,t.defaultEditorMode=null!==(o=e.jsonData.defaultEditorMode)&&void 0!==o?o:p.Visual,t.schemaMapper=new fe(u,l),t.expressionParser=new K(t.templateSrv),t.parseExpression=t.parseExpression.bind(Ne(t)),t.autoCompleteQuery=t.autoCompleteQuery.bind(Ne(t)),t.getSchemaMapper=t.getSchemaMapper.bind(Ne(t)),t}return t=i,(n=[{key:"filterQuery",value:function(e){var t,n;if(e.hide||!e.query)return!1;if(void 0===e.rawMode&&e.query)return!0;if(e.rawMode)return!0;var r=null===(t=e.expression)||void 0===t?void 0:t.from;return!!r&&!!(null===(n=r.property)||void 0===n?void 0:n.name)}},{key:"applyTemplateVariables",value:function(e,t){var n=ye(this.templateSrv.replace(e.query,t,this.interpolateVariable),t);return Object.assign(Object.assign({},e),{query:n,database:this.templateSrv.replace(e.database,t)})}},{key:"metricFindQuery",value:function(e,t){return o(this,void 0,void 0,regeneratorRuntime.mark((function n(){var r=this;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!e.match(/^databases\(\)/i)){n.next=3;break}return n.abrupt("return",this.getDatabases());case 3:return n.abrupt("return",this.getDefaultOrFirstDatabase().then((function(n){return r.buildQuery(e,t,n)})).then((function(e){return r.query({targets:[e]}).toPromise()})).then((function(e){return e.data&&e.data.length?P(e.data[0]):[]})).catch((function(e){throw e})));case 4:case"end":return n.stop()}}),n,this)})))}},{key:"getDatabases",value:function(){return o(this,void 0,void 0,regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.getResource("databases").then((function(e){return(new we).parseDatabases(e)})));case 1:case"end":return e.stop()}}),e,this)})))}},{key:"getResource",value:function(e){var t=this,n=Object.create(null,{getResource:{get:function(){return Te(De(i.prototype),"getResource",t)}}});return o(this,void 0,void 0,regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",n.getResource.call(this,e));case 1:case"end":return t.stop()}}),t,this)})))}},{key:"getDefaultOrFirstDatabase",value:function(){return o(this,void 0,void 0,regeneratorRuntime.mark((function e(){var t=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.defaultOrFirstDatabase){e.next=2;break}return e.abrupt("return",Promise.resolve(this.defaultOrFirstDatabase));case 2:return e.abrupt("return",this.getDatabases().then((function(e){return t.defaultOrFirstDatabase=e[0].value,t.defaultOrFirstDatabase})));case 3:case"end":return e.stop()}}),e,this)})))}},{key:"getSchema",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return o(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",ve("".concat(this.id,".schema.overview"),(function(){return n.getResource("schema").then((new we).parseSchemaResult)}),e));case 1:case"end":return t.stop()}}),t,this)})))}},{key:"getFunctionSchema",value:function(e,t){return o(this,void 0,void 0,regeneratorRuntime.mark((function n(){var r,a,o;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return(r=[]).push(t),r.push("take 50000"),r.push("getschema"),a=this.buildQuery(r.join("\n | "),{},e),n.next=8,this.query({targets:[Object.assign(Object.assign({},a),{querySource:"schema"})]}).toPromise();case 8:return o=n.sent,n.abrupt("return",Ve(o.data));case 10:case"end":return n.stop()}}),n,this)})))}},{key:"getDynamicSchema",value:function(e,t,n){return o(this,void 0,void 0,regeneratorRuntime.mark((function r(){var a,o,i,u,l,s;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(e&&t&&Array.isArray(n)&&0!==n.length){r.next=2;break}return r.abrupt("return",{});case 2:return a=[],o="where ".concat(n.map((function(e){return"isnotnull(".concat(e,")")})).join(" and ")),i="project ".concat(n.map((function(e){return e})).join(", ")),u="summarize ".concat(n.map((function(e){return"buildschema(".concat(e,")")})).join(", ")),a.push(t),a.push("take 50000"),a.push(o),a.push(i),a.push(u),l=this.buildQuery(a.join("\n | "),{},e),r.next=15,this.query({targets:[Object.assign(Object.assign({},l),{querySource:"schema"})]}).toPromise();case 15:return s=r.sent,r.abrupt("return",ze(s.data));case 17:case"end":return r.stop()}}),r,this)})))}},{key:"getVariables",value:function(){return this.templateSrv.getVariables().map((function(e){return"$".concat(e.name)}))}},{key:"buildQuery",value:function(e,t,n){t||(t={}),t.hasOwnProperty("scopedVars")||(t.scopedVars={});var r=ye(this.templateSrv.replace(e,t.scopedVars,this.interpolateVariable),t.scopedVars);return Object.assign(Object.assign({},h),{refId:"adx-".concat(r),resultFormat:"table",rawMode:!0,query:r,database:n})}},{key:"doRequest",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return this.backendSrv.datasourceRequest({url:this.url+e,method:"POST",data:t}).catch((function(a){if(r>0)return n.doRequest(e,t,r-1);throw a}))}},{key:"interpolateVariable",value:function(e,t){return"string"==typeof e?t.multi||t.includeAll?"'"+e+"'":e:"number"==typeof e?e:Object(U.map)(e,(function(t){return"number"==typeof e?e:"'"+qe(t)+"'"})).filter((function(e){return"''"!==e})).join(",")}},{key:"getSchemaMapper",value:function(){return this.schemaMapper}},{key:"parseExpression",value:function(e,t){return this.expressionParser.toQuery(e,t)}},{key:"getDefaultEditorMode",value:function(){return this.defaultEditorMode}},{key:"autoCompleteQuery",value:function(e,t){return o(this,void 0,void 0,regeneratorRuntime.mark((function n(){var r,a,o,i,u;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(r=this.expressionParser.toAutoCompleteQuery(e,t)){n.next=3;break}return n.abrupt("return",[]);case 3:return a=Object.assign(Object.assign({},h),{refId:"adx-".concat(r),database:e.database,rawMode:!0,query:r,resultFormat:"table",querySource:"autocomplete"}),n.next=6,this.query(Be({targets:[a]})).toPromise();case 6:if(o=n.sent,Array.isArray(null==o?void 0:o.data)&&0!==o.data.length){n.next=9;break}return n.abrupt("return",[]);case 9:if(Array.isArray(o.data[0].fields)&&0!==o.data[0].fields.length){n.next=11;break}return n.abrupt("return",[]);case 11:return i=o.data[0].fields[0].values.toArray(),u=e.search.operator,n.abrupt("return","contains"===u.name?Ue(i,u.value):i);case 14:case"end":return n.stop()}}),n,this)})))}}])&&Ae(t.prototype,n),r&&Ae(t,r),i}(s.DataSourceWithBackend),Ve=function(e){var t=[],n=e[0].fields;if(!n)return t;var r=n.findIndex((function(e){return"ColumnName"===e.name})),a=n.findIndex((function(e){return"ColumnType"===e.name}));if(r<0||a<0)return t;var o,i=je(e);try{for(i.s();!(o=i.n()).done;)for(var u=o.value,l=0;l<u.length;l++)t.push({Name:u.fields[r].values.get(l),CslType:u.fields[a].values.get(l)})}catch(e){i.e(e)}finally{i.f()}return t},ze=function(e){var t,n={},r=je(e);try{for(r.s();!(t=r.n()).done;){var a,o=je(t.value.fields);try{for(o.s();!(a=o.n()).done;){var i=a.value,u=JSON.parse(i.values.get(0));if(null!==u){var l=[],s=i.name.replace("schema_","");$e(s,u,l),n[s]=l}}}catch(e){o.e(e)}finally{o.f()}}}catch(e){r.e(e)}finally{r.f()}return n},$e=function e(t,n,r){if(n)for(var a=0,o=Object.keys(n);a<o.length;a++){var i=o[a],u="".concat(t,'["').concat(i,'"]');"string"!=typeof n[i]?"object"===Se(n[i])&&e(u,n[i],r):r.push({Name:u,CslType:n[i]})}},Be=function(e){var t,n=null===(t=Object(s.getTemplateSrv)())||void 0===t?void 0:t.timeRange;return n?Object.assign(Object.assign({},e),{range:n}):e},qe=function(e){return e.replace(/\'/gim,"\\'")},Ue=function(e,t){var n=t.toLowerCase();return e.sort((function(e,t){if(!e&&!t)return 0;if(!e&&t)return-1;if(e&&!t)return 1;var r=e.toLowerCase(),a=t.toLowerCase();return r.startsWith(n)&&a.startsWith(n)?0:r.startsWith(n)&&!a.startsWith(n)&&a.includes(n,1)||r.startsWith(n)&&!a.includes(n,1)?-1:!r.startsWith(n)&&r.includes(n,1)&&a.startsWith(n)||!r.includes(n,1)&&a.startsWith(n)?1:r.includes(n,1)&&!a.includes(n,1)?-1:!r.includes(n,1)&&a.includes(n,1)?1:0})),e},Ge=n(2);function We(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}var Xe=function(e){var t=Object(f.useStyles2)(Ke);return l.a.createElement("div",{className:t.container},l.a.createElement("div",{className:t.icon},l.a.createElement(f.Icon,{className:"spin-clockwise",name:"sync"})),l.a.createElement("span",null,"One moment, your schema is loading ..."))},Qe=function(e){var t=Object(f.useStyles2)(Ke);return l.a.createElement("div",{className:t.container},l.a.createElement("div",{className:t.icon},l.a.createElement(f.Icon,{name:"exclamation-triangle",className:t.error})),l.a.createElement("span",{className:t.error},e.message))},He=function(e){var t=Object(f.useStyles2)(Ke);return l.a.createElement("div",{className:t.container},l.a.createElement("div",{className:t.icon},l.a.createElement(f.Icon,{name:"exclamation-triangle",className:t.warning})),l.a.createElement("span",{className:t.warning},e.message))},Ke=function(e){return{container:Object(Ge.css)(Fe||(Fe=We(["\n    margin-top: 10px;\n    display: flex;\n    flex-direction: row;\n  "]))),icon:Object(Ge.css)(Pe||(Pe=We(["\n    margin-right: 4px;\n  "]))),error:Object(Ge.css)(Le||(Le=We(["\n    color: ",";\n  "])),e.v1.colors.formInputBorderInvalid),warning:Object(Ge.css)(Me||(Me=We(["\n    color: ",";\n  "])),e.v1.palette.yellow)}};function Je(e){return(Je="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var Ze=function(e){var t,n;return"string"==typeof(null===(n=null===(t=null==e?void 0:e.from)||void 0===t?void 0:t.expression)||void 0===n?void 0:n.value)},Ye=function(e){var t,n,r,a,o,u,l,s,c,f,p,d,m,v,y;if(!e)return h.expression;var b=Object.assign({},h.expression);return"string"==typeof(null===(n=null===(t=null==e?void 0:e.from)||void 0===t?void 0:t.expression)||void 0===n?void 0:n.value)&&(b.from=at(null===(r=null==e?void 0:e.from)||void 0===r?void 0:r.expression)),Array.isArray(null===(o=null===(a=null==e?void 0:e.where)||void 0===a?void 0:a.expression)||void 0===o?void 0:o.expressions)&&(b.where={type:i.And,expressions:null===(l=null===(u=null==e?void 0:e.where)||void 0===u?void 0:u.expression)||void 0===l?void 0:l.expressions.map(tt).filter((function(e){return!!e})).map((function(e){return{type:i.Or,expressions:[e]}}))}),Array.isArray(null===(c=null===(s=null==e?void 0:e.reduce)||void 0===s?void 0:s.expression)||void 0===c?void 0:c.expressions)&&(b.reduce=et(null===(p=null===(f=null==e?void 0:e.reduce)||void 0===f?void 0:f.expression)||void 0===p?void 0:p.expressions)),Array.isArray(null===(m=null===(d=null==e?void 0:e.groupBy)||void 0===d?void 0:d.expression)||void 0===m?void 0:m.expressions)&&(b.groupBy=et(null===(y=null===(v=null==e?void 0:e.groupBy)||void 0===v?void 0:v.expression)||void 0===y?void 0:y.expressions)),b},et=function(e){return Array.isArray(e)?{type:i.And,expressions:e.map(tt).filter((function(e){return!!e}))}:{type:i.And,expressions:[]}},tt=function(e){switch(null==e?void 0:e.type){case"fieldAndOperator":return ot(e);case"field":return at(e);case"reduce":return rt(e);case"groupBy":return nt(e);default:return}},nt=function(e){if("groupBy"===(null==e?void 0:e.type)&&"object"===Je(null==e?void 0:e.field))return"object"!==Je(null==e?void 0:e.interval)?{type:i.GroupBy,property:it(null==e?void 0:e.field)}:{type:i.GroupBy,property:it(null==e?void 0:e.field),interval:it(null==e?void 0:e.interval)}},rt=function(e){if("reduce"===(null==e?void 0:e.type)&&"object"===Je(null==e?void 0:e.field))return Array.isArray(null==e?void 0:e.parameters)?{type:i.Reduce,property:it(null==e?void 0:e.field),reduce:it(null==e?void 0:e.reduce),parameters:e.parameters}:{type:i.Reduce,property:it(null==e?void 0:e.field),reduce:it(null==e?void 0:e.reduce)}},at=function(e){if("field"===(null==e?void 0:e.type)&&"string"==typeof(null==e?void 0:e.value))return{type:i.Property,property:it(e)}},ot=function(e){var t,n,r,a,o,u,l,s;if("string"==typeof(null===(t=null==e?void 0:e.field)||void 0===t?void 0:t.value)&&"string"==typeof(null===(r=null===(n=null==e?void 0:e.operator)||void 0===n?void 0:n.operator)||void 0===r?void 0:r.value))return{type:i.Operator,property:it(null==e?void 0:e.field),operator:{name:null===(o=null===(a=null==e?void 0:e.operator)||void 0===a?void 0:a.operator)||void 0===o?void 0:o.value,value:null!==(l=null===(u=null==e?void 0:e.operator)||void 0===u?void 0:u.value)&&void 0!==l?l:null===(s=null==e?void 0:e.operator)||void 0===s?void 0:s.values}}},it=function(e){return{type:ut(e.fieldType),name:e.value}},ut=function(e){switch(e){case"boolean":return D.Boolean;case"dateTime":return D.DateTime;case"function":return D.Function;case"number":return D.Number;case"interval":return D.Interval;default:return D.String}};function lt(e){var t;return!(void 0!==e.rawMode||!e.query||(null===(t=e.expression)||void 0===t?void 0:t.from))||(e.rawMode||!1)}var st=n(7);function ct(e,t,n){void 0===t&&(t=[]),void 0===n&&(n={loading:!1});var r,a,o=Object(u.useRef)(0),i=(r=Object(u.useRef)(!1),a=Object(u.useCallback)((function(){return r.current}),[]),Object(u.useEffect)((function(){return r.current=!0,function(){r.current=!1}})),a),l=Object(u.useState)(n),s=l[0],c=l[1];return[s,Object(u.useCallback)((function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var r=++o.current;return c((function(e){return Object(st.a)(Object(st.a)({},e),{loading:!0})})),e.apply(void 0,t).then((function(e){return i()&&r===o.current&&c({value:e,loading:!1}),e}),(function(e){return i()&&r===o.current&&c({error:e,loading:!1}),e}))}),t)]}function ft(e,t){void 0===t&&(t=[]);var n=ct(e,t,{loading:!0}),r=n[0],a=n[1];return Object(u.useEffect)((function(){a()}),[a]),r}var pt,dt=function(e){return l.a.createElement("div",{className:"gf-form"},l.a.createElement(f.InlineFormLabel,{className:"query-keyword",width:12,tooltip:e.tooltip},e.label),e.children)};function mt(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,a,o=[],i=!0,u=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(e){u=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(u)throw a}}return o}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return vt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return vt(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function vt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var ht,yt=function(e){var t=e.dirty,n=e.editorMode,r=e.onToggleEditorMode,a=mt(Object(u.useState)(!1),2),o=a[0],i=a[1],s=Object(u.useCallback)((function(){t&&n!==p.Visual?i(!0):r()}),[i,r,t,n]),c=Object(f.useStyles2)(bt);return l.a.createElement(dt,{label:"Database"},l.a.createElement(f.Select,{width:30,options:e.databases,placeholder:"Select database","aria-label":y.queryEditor.database.input,value:e.database,onChange:function(t){t&&t.value&&e.onChangeDatabase(t.value)}}),e.editorMode===p.Raw&&l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:c.spacing}),l.a.createElement("label",{className:"gf-form-label"},"(Run Query: Shift+Enter, Trigger Suggestion: Ctrl+Space)")),l.a.createElement("div",{className:"gf-form gf-form--grow"},l.a.createElement("div",{className:"gf-form-label--grow"})),l.a.createElement(f.Button,{variant:"secondary","aria-label":y.queryEditor.editKQL.button,onClick:s},e.editorMode===p.Visual?"Edit KQL":"Switch to builder"),l.a.createElement("div",{className:c.spacing}),l.a.createElement(f.Button,{variant:e.dirty?"primary":"secondary","aria-label":y.queryEditor.runQuery.button,onClick:e.onRunQuery},"Run Query"),l.a.createElement(f.ConfirmModal,{isOpen:o,title:"Are you sure?",body:"You might lose manual changes done to the query if you go back to the visual builder.",confirmText:"Yes, I am sure.",dismissText:"No, continue edit query manually.",icon:"exclamation-triangle",onConfirm:function(){i(!1),e.onToggleEditorMode()},onDismiss:function(){return i(!1)}}))},bt=function(e){return{spacing:Object(Ge.css)(pt||(t=["\n    margin-right: 4px;\n  "],n||(n=t.slice(0)),pt=Object.freeze(Object.defineProperties(t,{raw:{value:Object.freeze(n)}}))))};var t,n};var gt=[{label:"Time series",value:"time_series"},{label:"Table",value:"table"}],Et={label:"ADX Time series",value:"time_series_adx_series"},Ot=function(e){var t=e.onChangeFormat,n=Object(u.useCallback)((function(e){e&&e.value&&t(e.value)}),[t]),r=Object(f.useStyles2)(wt);return l.a.createElement("div",{className:r.container},l.a.createElement(f.InlineFormLabel,{className:"query-keyword",width:6},"Format as"),l.a.createElement(f.Select,{options:e.includeAdxTimeFormat?[].concat(gt,[Et]):gt,value:e.format,onChange:n,menuShouldPortal:!0}))},wt=function(e){return{container:Object(Ge.css)(ht||(t=["\n    display: flex;\n    flex-direction: row;\n    margin-right: 4px;\n  "],n||(n=t.slice(0)),ht=Object.freeze(Object.defineProperties(t,{raw:{value:Object.freeze(n)}}))))};var t,n},St=function(e,t){var n=gt.find((function(t){return t.value===e}));return t&&Et.value&&Et.value===e?Et.value:n&&n.value?n.value:gt.length>0&&gt[0].value?gt[0].value:"time_series"};function jt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ct,At=function(){function e(t,n,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.containerDiv=t,this.defaultTimeField=n,this.getSchema=r,this.config=a,this.splitWithNewLineRegex=/[^\n]+\n?|\n/g,this.newLineRegex=/\r?\n/,this.startsWithKustoPipeRegex=/^\|\s*/g,this.kustoPipeRegexStrict=/^\|\s*$/g}var t,n,r;return t=e,(n=[{key:"initMonaco",value:function(e){var t,n=this,r=this.config.bootData.user.lightTheme?"grafana-light":"vs-dark";monaco.editor.defineTheme("grafana-light",{base:"vs",inherit:!0,rules:[{token:"comment",foreground:"008000"},{token:"variable.predefined",foreground:"800080"},{token:"function",foreground:"0000FF"},{token:"operator.sql",foreground:"FF4500"},{token:"string",foreground:"B22222"},{token:"operator.scss",foreground:"0000FF"},{token:"variable",foreground:"C71585"},{token:"variable.parameter",foreground:"9932CC"},{token:"",foreground:"000000"},{token:"type",foreground:"0000FF"},{token:"tag",foreground:"0000FF"},{token:"annotation",foreground:"2B91AF"},{token:"keyword",foreground:"0000FF"},{token:"number",foreground:"191970"},{token:"annotation",foreground:"9400D3"},{token:"invalid",background:"cd3131"}],colors:{"textCodeBlock.background":"#FFFFFF"}});try{monaco.languages.kusto.kustoDefaults.setLanguageSettings({includeControlCommands:!0,newlineAfterPipe:!0,useIntellisenseV2:!1})}catch(e){t=new Error("Unable to load Kusto language. Try refreshing the page or upgrading to Grafana +8.5 and ADX plugin +4.0")}return this.codeEditor=monaco.editor.create(this.containerDiv,{value:e||"Write your query here",language:"kusto",selectionHighlight:!1,theme:r,folding:!0,lineNumbers:"off",lineHeight:16,suggestFontSize:13,dragAndDrop:!1,occurrencesHighlight:!1,minimap:{enabled:!1},renderIndentGuides:!1,wordWrap:"on"}),this.codeEditor.layout(),1===monaco.editor.getModels().length&&(this.completionItemProvider=monaco.languages.registerCompletionItemProvider("kusto",{triggerCharacters:["."," "],provideCompletionItems:this.getCompletionItems.bind(this)}),this.signatureHelpProvider=monaco.languages.registerSignatureHelpProvider("kusto",{signatureHelpTriggerCharacters:["(",")"],provideSignatureHelp:this.getSignatureHelp.bind(this)})),this.codeEditor.createContextKey("readyToExecute",!0),this.codeEditor.onDidChangeCursorSelection((function(e){n.onDidChangeCursorSelection(e)})),this.getSchema().then((function(e){e&&monaco.languages.kusto.getKustoWorker().then((function(t){var r,a=null===(r=n.codeEditor)||void 0===r?void 0:r.getModel();a&&t(a.uri).then((function(t){var r,a=Object.keys(e.Databases).length>0?Object.keys(e.Databases)[0]:"";t.setSchemaFromShowSchema(e,"https://help.kusto.windows.net",a),null===(r=n.codeEditor)||void 0===r||r.layout()}))}))})),t}},{key:"resize",value:function(){var e;null===(e=this.codeEditor)||void 0===e||e.layout()}},{key:"setOnDidChangeModelContent",value:function(e){var t;null===(t=this.codeEditor)||void 0===t||t.onDidChangeModelContent(e)}},{key:"disposeMonaco",value:function(){if(this.completionItemProvider)try{this.completionItemProvider.dispose()}catch(e){}if(this.signatureHelpProvider)try{this.signatureHelpProvider.dispose()}catch(e){}if(this.codeEditor)try{this.codeEditor.dispose()}catch(e){}}},{key:"addCommand",value:function(e,t){var n;null===(n=this.codeEditor)||void 0===n||n.addCommand(e,t,"readyToExecute")}},{key:"getValue",value:function(){var e;return null===(e=this.codeEditor)||void 0===e?void 0:e.getValue()}},{key:"toSuggestionController",value:function(e){return e}},{key:"setEditorContent",value:function(e){var t;null===(t=this.codeEditor)||void 0===t||t.setValue(e)}},{key:"getCompletionItems",value:function(e,t){var n="##### Macro that uses the selected timerange in Grafana to filter the query.\n\n- `$__timeFilter()` -> Uses the "+this.defaultTimeField+" column\n\n- `$__timeFilter(datetimeColumn)` ->  Uses the specified datetime column to build the query.",r=e.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:t.lineNumber,endColumn:t.column});return G.a.includes(r,"|")?G.a.includes(r.toLowerCase(),"where")?G.a.includes(e.getLineContent(t.lineNumber).toLowerCase(),"where")?[{label:"$__timeFilter(timeColumn)",kind:monaco.languages.CompletionItemKind.Keyword,insertText:{value:"\\$__timeFilter(${0:"+this.defaultTimeField+"})"},documentation:{value:n}},{label:"$__from",kind:monaco.languages.CompletionItemKind.Keyword,insertText:{value:"\\$__from"},documentation:{value:"Built-in variable that returns the from value of the selected timerange in Grafana.\n\nExample: `where "+this.defaultTimeField+" > $__from` "}},{label:"$__to",kind:monaco.languages.CompletionItemKind.Keyword,insertText:{value:"\\$__to"},documentation:{value:"Built-in variable that returns the to value of the selected timerange in Grafana.\n\nExample: `where "+this.defaultTimeField+" < $__to` "}},{label:"$__timeInterval",kind:monaco.languages.CompletionItemKind.Keyword,insertText:{value:"\\$__timeInterval"},documentation:{value:"##### Built-in variable that returns an automatic time grain suitable for the current timerange.\n\nUsed with the bin() function - `bin("+this.defaultTimeField+", $__timeInterval)` \n\n[Grafana docs](http://docs.grafana.org/reference/templating/#the-interval-variable)"}}]:[]:[{label:"where $__timeFilter(timeColumn)",kind:monaco.languages.CompletionItemKind.Keyword,insertText:{value:"where \\$__timeFilter(${0:"+this.defaultTimeField+"})"},documentation:{value:n}}]:[]}},{key:"getSignatureHelp",value:function(e,t,n){return"$__timeFilter("!==e.getValueInRange({startLineNumber:t.lineNumber,startColumn:t.column-14,endLineNumber:t.lineNumber,endColumn:t.column})?{}:{activeParameter:0,activeSignature:0,signatures:[{label:"$__timeFilter(timeColumn)",parameters:[{label:"timeColumn",documentation:"Default is "+this.defaultTimeField+" column. Datetime column to filter data using the selected date range. "}]}]}}},{key:"onDidChangeCursorSelection",value:function(e){"modelChange"===e.source&&e.reason===monaco.editor.CursorChangeReason.RecoverFromMarkers&&" "===this.getCharAt(e.selection.positionLineNumber,e.selection.positionColumn-1)&&this.triggerSuggestions()}},{key:"triggerSuggestions",value:function(){var e,t=null===(e=this.codeEditor)||void 0===e?void 0:e.getContribution("editor.contrib.suggestController");if(t){var n=this.toSuggestionController(t);n._model.cancel(),setTimeout((function(){n._model.trigger(!0)}),10)}}},{key:"getCharAt",value:function(e,t){var n,r=null===(n=this.codeEditor)||void 0===n?void 0:n.getModel();if(!r)return"";if(0===r.getLineCount()||r.getLineCount()<e)return"";var a=r.getLineContent(e);return a.length<t||t<1?"":a[t-1]}}])&&jt(t.prototype,n),r&&jt(t,r),e}();function Tt(e){return(Tt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function It(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function xt(e,t){return(xt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Rt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Nt(e);if(t){var a=Nt(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return kt(this,n)}}function kt(e,t){if(t&&("object"===Tt(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function Nt(e){return(Nt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Dt,Ft=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&xt(e,t)}(o,e);var t,n,r,a=Rt(o);function o(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(t=a.call(this,e)).getStyles=Object(f.stylesFactory)((function(){return{editor:Object(Ge.css)(Ct||(e=["\n      width: 100%;\n      height: 350px;\n    "],t||(t=e.slice(0)),Ct=Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))))};var e,t})),t.styles=t.getStyles(),t.monacoRef=l.a.createRef(),t.state={},window.hasOwnProperty("monaco")?setTimeout((function(){t.initMonaco()}),1):window.System.import("".concat(e.pluginBaseUrl,"/libs/monaco.min.js")).then((function(){setTimeout((function(){t.initMonaco()}),1)})),t}return t=o,(n=[{key:"initMonaco",value:function(){var e=this;this.kustoCodeEditor=new At(this.monacoRef.current,this.props.defaultTimeField,this.props.getSchema,s.config);var t=this.kustoCodeEditor.initMonaco(this.props.content);t&&this.setState({error:t}),this.kustoCodeEditor.addCommand(monaco.KeyMod.Shift|monaco.KeyCode.Enter,(function(){var t,n=null===(t=e.kustoCodeEditor)||void 0===t?void 0:t.getValue();e.props.onChange(n),e.props.onExecute()})),this.kustoCodeEditor.setOnDidChangeModelContent((function(){var t,n=null===(t=e.kustoCodeEditor)||void 0===t?void 0:t.getValue();e.props.onChange(n)})),window.onresize=function(){var t;null===(t=e.kustoCodeEditor)||void 0===t||t.resize()}}},{key:"componentWillUnmount",value:function(){this.kustoCodeEditor&&this.kustoCodeEditor.disposeMonaco()}},{key:"render",value:function(){return l.a.createElement(l.a.Fragment,null,this.state.error&&l.a.createElement(f.Alert,{title:"Error loading editor",severity:"warning"},this.state.error.message),l.a.createElement("div",{id:"content",tabIndex:0,className:this.styles.editor,ref:this.monacoRef}))}}])&&It(t.prototype,n),r&&It(t,r),o}(l.a.Component),Pt=n(6);function Lt(e,t){var n=t.delta(0,-1);return"__timeFilter"!==e.getWordUntilPosition(n).word?{value:{activeParameter:0,activeSignature:0,signatures:[]},dispose:function(){}}:{value:{activeParameter:0,activeSignature:0,signatures:[{label:"$__timeFilter(timeColumn)",parameters:[{label:"timeColumn",documentation:"Default is TimeGenerated column. Datetime column to filter data using the selected date range. "}]}]},dispose:function(){}}}function Mt(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,a,o=[],i=!0,u=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(e){u=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(u)throw a}}return o}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return _t(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _t(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _t(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Vt=["//change this to create your own time series query","","<table name>","| where $__timeFilter(Timestamp)","// | summarize count() by <group by column>, bin(Timestamp, $__timeInterval)","// | order by Timestamp asc"].join("\n");var zt,$t=function(e){var t=Mt(Object(u.useState)(!1),2),n=t[0],r=t[1],a=Mt(Object(u.useState)(!1),2),i=a[0],c=a[1],p=Mt(Object(u.useState)(),2),d=p[0],m=p[1],v=Mt(Object(u.useState)(Object(s.getTemplateSrv)().getVariables()),1)[0],h=function(t){var n=St(e.query.resultFormat,!0);e.onChange(Object.assign(Object.assign({},e.query),{query:t,database:e.database,resultFormat:n}))},b=e.query,g=e.datasource,E=e.lastQueryError,O=e.lastQuery,w=e.timeNotASC,S=e.schema,j=St(b.resultFormat,!0),C="".concat(s.config.appSubUrl,"/").concat(g.meta.baseUrl),A=Object(f.useStyles2)(Bt);return Object(u.useEffect)((function(){d&&S&&(Object.keys(S.Databases).forEach((function(e){return Object.assign(S.Databases[e].Functions,function(e){var t={$__timeFilter:{Name:"$__timeFilter",Body:"{ true }",FunctionKind:"Unknown",InputParameters:[{Name:"timeColumn",CslType:"string",Type:"System.String",CslDefaultValue:'""'}],OutputColumns:[],DocString:"##### Macro that uses the selected timerange in Grafana to filter the query.\n\n- `$__timeFilter()` -> Uses the TimeGenerated column\n\n- `$__timeFilter(datetimeColumn)` ->  Uses the specified datetime column to build the query."},$__from:{Name:"$__from",Body:"{ datetime(2018-06-05T18:09:58.907Z) }",FunctionKind:"Unknown",DocString:"Built-in variable that returns the from value of the selected timerange in Grafana.\n\nExample: `where TimeGenerated > $__from` ",InputParameters:[],OutputColumns:[]},$__to:{Name:"$__to",Body:"{ datetime(2018-06-05T18:09:58.907Z) }",FunctionKind:"Unknown",DocString:"Built-in variable that returns the to value of the selected timerange in Grafana.\n\nExample: `where TimeGenerated < $__to` ",InputParameters:[],OutputColumns:[]},$__timeInterval:{Name:"$__timeInterval",Body:"{ 1s }",FunctionKind:"Unknown",DocString:"##### Built-in variable that returns an automatic time grain suitable for the current timerange.\n\nUsed with the bin() function - `bin(TimeGenerated, $__timeInterval)` \n\n[Grafana docs](http://docs.grafana.org/reference/templating/#the-interval-variable)",InputParameters:[],OutputColumns:[]}};return e.forEach((function(e){t["$".concat(e.name)]={Name:"$".concat(e.name),Body:"{}",FunctionKind:"Unknown",InputParameters:[],OutputColumns:[]}})),t}(v))})),d.setSchemaFromShowSchema(S,"https://help.kusto.windows.net",e.database))}),[d,S,v,e.database]),S?l.a.createElement("div",null,Object(Pt.valid)(s.config.buildInfo.version)&&Object(Pt.gte)(s.config.buildInfo.version,"8.5.0")?l.a.createElement("div",{"data-testid":y.queryEditor.codeEditor.container},l.a.createElement(f.CodeEditor,{language:"kusto",value:b.query||Vt,onBlur:h,showMiniMap:!1,showLineNumbers:!0,height:"240px",onEditorDidMount:function(e,t){t.languages.registerSignatureHelpProvider("kusto",{signatureHelpTriggerCharacters:["(",")"],provideSignatureHelp:Lt}),t.languages.kusto.getKustoWorker().then((function(t){var n=e.getModel();return n&&t(n.uri)})).then((function(e){m(e)}))}})):l.a.createElement("div",{"data-testid":y.queryEditor.codeEditorLegacy.container},l.a.createElement(Ft,{defaultTimeField:"Timestamp",pluginBaseUrl:C,content:b.query||Vt,getSchema:function(){return o(void 0,void 0,void 0,regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",S);case 1:case"end":return e.stop()}}),e)})))},onChange:h,onExecute:e.onRunQuery})),l.a.createElement("div",{className:A.toolbar},l.a.createElement(Ot,{includeAdxTimeFormat:!0,format:j,onChangeFormat:function(t){e.onChange(Object.assign(Object.assign({},e.query),{resultFormat:t}))}}),l.a.createElement("div",{className:"gf-form"},l.a.createElement("label",{className:"gf-form-label query-keyword",onClick:function(){return c(!i)}},"Show Help ",l.a.createElement(f.Icon,{name:i?"angle-down":"angle-right"}))),l.a.createElement("div",{className:"gf-form","ng-show":"ctrl.lastQuery"},l.a.createElement("label",{className:"gf-form-label query-keyword",onClick:function(){return r(!n)}},"Raw Query ",l.a.createElement(f.Icon,{name:n?"angle-down":"angle-right"}))),l.a.createElement("div",{className:"gf-form gf-form--grow"},l.a.createElement("div",{className:"gf-form-label gf-form-label--grow"}))),n&&l.a.createElement("div",{className:"gf-form"},l.a.createElement("pre",{className:"gf-form-pre"},O)),E&&l.a.createElement("div",{className:"gf-form"},l.a.createElement("pre",{className:"gf-form-pre alert alert-error"},E)),w&&l.a.createElement("div",{className:"gf-form"},l.a.createElement("pre",{className:"gf-form-pre alert alert-warning"},"Data is not sorted ascending by Time. Recommend adding an order by clause.")),i&&l.a.createElement("div",{className:"gf-form"},l.a.createElement("pre",{className:"gf-form-pre alert alert-info"},'\n  Format as Table:\n  - Can return any set of columns.\n\n  Format as Time series:\n  - Requires exactly one column of Kusto type datetime. (tip: can use Kusto\'s project-away operator to remove columns).\n  - Requires at least one value column of a number type. Each value column is considered a metric.\n  - May optionally have one or more string columns. Each string column is considered as a key=value tag pair (where the key is the column name, and the value is the value of the column for each row).\n  - A time series is returned for each value column + unique set of string column values. Each series has name of valueColumnName { stringColumnName=columnValue, ... }. If there are no string columns in the request, the name will just be valueColumnName.\n  - Example Time Series Query:\n    AzureActivity\n      | where $__timeFilter()\n      | summarize count() by Category, bin(TimeGenerated, 60min)\n      | order by TimeGenerated asc\n\n  Format as ADX Time series:\n   - Used for queries that return Kusto\'s "time series" type, such as the make-series operator\n   - Must have a datetime column named "Timestamp"\n   - Example ADX Time series query:\n    let T = range Timestamp from $__timeFrom to $__timeTo step $__timeInterval * 4\n      | extend   Person = dynamic(["Torkel", "Daniel", "Kyle", "Sofia"]) \n      | extend   Place  = dynamic(["EU",     "EU",     "US",   "EU"]) \n      | mvexpand Person, Place\n      | extend   HatInventory = rand(5) \n      | project  Timestamp, tostring(Person), tostring(Place), HatInventory;\n    T | make-series avg(HatInventory) on Timestamp from $__timeFrom to $__timeTo step $__timeInterval * 4 by Person, Place;\n\n\n  Time Macros:\n  - $__timeFilter -&gt; TimeGenerated &ge; datetime(2018-06-05T18:09:58.907Z) and TimeGenerated &le; datetime(2018-06-05T20:09:58.907Z)\n  - $__timeFilter(datetimeColumn) -&gt;  datetimeColumn  &ge; datetime(2018-06-05T18:09:58.907Z) and datetimeColumn &le; datetime(2018-06-05T20:09:58.907Z)\n  - $__timeFrom -&gt;  datetime(2018-06-05T18:09:58.907Z) [the start time of the query]\n  - $__timeTo -&gt; datetime(2018-06-05T20:09:58.907Z) [the end time of the query]\n  - $__timeInterval -&gt; 5000ms [Grafana\'s recommended bin size based on the timespan of the query, in ms]\n\n  Templating Macros:\n  - $__escapeMulti($myTemplateVar) -&gt; $myTemplateVar should be a multi-value template variables that contains illegal characters\n  - $__contains(aColumn, $myTemplateVar) -&gt; aColumn in ($myTemplateVar)\n    If using the All option, then check the Include All Option checkbox and in the Custom all value field type in: all. If All is chosen -&gt; 1 == 1\n\n  Macro Examples:\n  - Â¡ where $__timeFilter()\n  - | where TimeGenerated &ge; $__timeFrom() and TimeGenerated &le; $__timeTo()\n  - | summarize count() by Category, bin(TimeGenerated, $__timeInterval)'))):null},Bt=function(e){return{toolbar:Object(Ge.css)(Dt||(t=["\n    display: flex;\n    flex-direction: row;\n    margin-top: 4px;\n  "],n||(n=t.slice(0)),Dt=Object.freeze(Object.defineProperties(t,{raw:{value:Object.freeze(n)}}))))};var t,n};function qt(e){return function(e){if(Array.isArray(e))return Wt(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Gt(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ut(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,a,o=[],i=!0,u=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(e){u=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(u)throw a}}return o}(e,t)||Gt(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Gt(e,t){if(e){if("string"==typeof e)return Wt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Wt(e,t):void 0}}function Wt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Xt=function(e){return{name:e.value,type:e.type}},Qt=function(e){var t=e.value,n=e.fields,r=e.allowCustom,a=e.placeholder,o=e.templateVariableOptions,i=e.onChange,s=Ut(Object(u.useState)(null),2),c=s[0],p=s[1],d=Object(f.useStyles2)(Ht),m=Kt(n),v=Object(u.useMemo)((function(){return m.find((function(e){return e.value===(null==t?void 0:t.name)}))}),[m,t]),h=Object(u.useMemo)((function(){return Zt(m,o)}),[m,o]),y=Jt(e,t,p),b=Object(u.useCallback)((function(){!v&&c&&i(Object.assign({},c)),p(null)}),[i,p,c,v]);return l.a.createElement("div",{className:d.container},l.a.createElement(f.AsyncSelect,{width:30,onChange:y,value:v,defaultOptions:o?[o].concat(qt(m)):m,loadOptions:h,placeholder:a,menuPlacement:"bottom",allowCustomValue:r,backspaceRemovesValue:!0,isClearable:!0,onCloseMenu:b,"aria-label":e["aria-label"]}))},Ht=function(e){return{container:Object(Ge.css)(zt||(t=["\n    margin-right: 4px;\n  "],n||(n=t.slice(0)),zt=Object.freeze(Object.defineProperties(t,{raw:{value:Object.freeze(n)}}))))};var t,n},Kt=function(e){return Object(u.useMemo)((function(){return e?e.map((function(e){var t;return{label:null!==(t=e.label)&&void 0!==t?t:e.value,value:e.value,type:e.type}})):[]}),[e])},Jt=function(e,t,n){var r=e.fields,a=e.allowCustom,o=e.templateVariableOptions,i=e.onChange;return Object(u.useCallback)((function(e){var u;if(!e||"string"!=typeof e.value&&t){var l=D.String;return i({name:null,type:l}),void(t&&n(t))}var s=e.value,c=r.find((function(e){return e.value===s}));c||(c=null===(u=null==o?void 0:o.options)||void 0===u?void 0:u.find((function(e){return e.value===s}))),!c&&s&&a&&(c={value:s,type:D.String}),c&&i({name:c.value,type:c.type})}),[r,i,o,a,t,n])},Zt=function(e,t){return function(n){return o(void 0,void 0,void 0,regeneratorRuntime.mark((function r(){var a,o,i,u,l,s;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=n.toLowerCase(),o=t?[t].concat(qt(e)):e,i=o.filter((function(e){var t;return null===(t=e.label)||void 0===t?void 0:t.toLowerCase().startsWith(a)})),u=o.filter((function(e){var t;return-1!==(null===(t=e.label)||void 0===t?void 0:t.toLowerCase().indexOf(a,1))})),l=i.concat(u),s=qt(new Set(l)),r.abrupt("return",s);case 7:case"end":return r.stop()}}),r)})))}};function Yt(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,a,o=[],i=!0,u=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(e){u=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(u)throw a}}return o}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return en(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return en(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function en(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function tn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var nn=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.datasource=t}var t,n,r;return t=e,(n=[{key:"createCacheKey",value:function(e){return"".concat("AdxSchemaResolver",".").concat(this.datasource.id,".").concat(e)}},{key:"getDatabases",value:function(){return o(this,void 0,void 0,regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.datasource.getSchema();case 2:return t=e.sent,e.abrupt("return",Object.keys(t.Databases).map((function(e){return t.Databases[e]})));case 4:case"end":return e.stop()}}),e,this)})))}},{key:"getTablesForDatabase",value:function(e){return o(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n,r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.getDatabases();case 2:if(n=t.sent,r=n.find((function(t){return t.Name===e}))){t.next=6;break}return t.abrupt("return",[]);case 6:return t.abrupt("return",Object.keys(r.Tables).map((function(e){return r.Tables[e]})));case 7:case"end":return t.stop()}}),t,this)})))}},{key:"getViewsForDatabase",value:function(e){return o(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n,r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.getDatabases();case 2:if(n=t.sent,r=n.find((function(t){return t.Name===e}))){t.next=6;break}return t.abrupt("return",[]);case 6:return t.abrupt("return",Object.keys(r.MaterializedViews).map((function(e){return r.MaterializedViews[e]})));case 7:case"end":return t.stop()}}),t,this)})))}},{key:"getFunctionsForDatabase",value:function(e){return o(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n,r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.getDatabases();case 2:if(n=t.sent,r=n.find((function(t){return t.Name===e}))){t.next=6;break}return t.abrupt("return",[]);case 6:return t.abrupt("return",Object.keys(r.Functions).map((function(e){return r.Functions[e]})));case 7:case"end":return t.stop()}}),t,this)})))}},{key:"getColumnsForTable",value:function(e,t){return o(this,void 0,void 0,regeneratorRuntime.mark((function n(){var r,a,i=this;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r=this.createCacheKey("db.".concat(e,".").concat(t)),a=this.datasource.getSchemaMapper(),n.abrupt("return",ve(r,(function(){return o(i,void 0,void 0,regeneratorRuntime.mark((function n(){var r,o,i,u,l;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return o=a.getMappingByValue(t),n.next=3,this.findSchema(e,t,o);case 3:if(i=n.sent){n.next=6;break}return n.abrupt("return",[]);case 6:if((null==o?void 0:o.type)!==m.function){n.next=10;break}return n.next=9,this.datasource.getFunctionSchema(e,o.value);case 9:i.OrderedColumns=n.sent;case 10:return u=i.OrderedColumns.filter((function(e){return"dynamic"===e.CslType})).map((function(e){return e.Name})),n.next=13,this.datasource.getDynamicSchema(e,null!==(r=null==o?void 0:o.name)&&void 0!==r?r:t,u);case 13:return l=n.sent,n.abrupt("return",i.OrderedColumns.reduce((function(e,t){var n=l[t.Name];return Array.isArray(n)?(Array.prototype.push.apply(e,n),e):(e.push(t),e)}),[]));case 15:case"end":return n.stop()}}),n,this)})))})));case 3:case"end":return n.stop()}}),n,this)})))}},{key:"findSchema",value:function(e,t,n){var r;return o(this,void 0,void 0,regeneratorRuntime.mark((function a(){var o,i,u,l,s,c,f,p,d;return regeneratorRuntime.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,Promise.all([this.getTablesForDatabase(e),this.getFunctionsForDatabase(e),this.getViewsForDatabase(e)]);case 2:if(o=a.sent,i=Yt(o,3),u=i[0],l=i[1],s=i[2],c=null!==(r=null==n?void 0:n.name)&&void 0!==r?r:t,!(f=u.find((function(e){return e.Name===c})))){a.next=11;break}return a.abrupt("return",f);case 11:if(!(p=s.find((function(e){return e.Name===c})))){a.next=14;break}return a.abrupt("return",p);case 14:if(!(d=l.find((function(e){return e.Name===c})))){a.next=17;break}return a.abrupt("return",{Name:d.Name,OrderedColumns:d.OutputColumns});case 17:return a.abrupt("return");case 18:case"end":return a.stop()}}),a,this)})))}}])&&tn(t.prototype,n),r&&tn(t,r),e}(),rn=function(e){return function(t){e({type:i.Property,property:t})}};function an(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var on=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,(n=[{key:"build",value:function(){return e={defaultValue:this.buildFieldExpression()},function(t){var n,r=t.onChange,a=null!==(n=t.value)&&void 0!==n?n:e.defaultValue;return M(a)?l.a.createElement(dt,{label:t.label},l.a.createElement(Qt,{fields:t.fields,templateVariableOptions:t.templateVariableOptions,onChange:rn(r),value:a.property,allowCustom:t.allowCustom,"aria-label":t["aria-label"]}),t.children):null};var e}},{key:"buildFieldExpression",value:function(){return{type:i.Property,property:{name:"",type:D.String}}}}])&&an(t.prototype,n),r&&an(t,r),e}();function un(e){return function(e){if(Array.isArray(e))return ln(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return ln(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ln(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ln(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var sn=function(e){var t=e.onChange,n=e.children,r=e.value,a=Object(u.useCallback)((function(e,n){var a=un(r.expressions);n?a.splice(e,1,n):a.splice(e,1);var o=a.filter((function(e){return!("expressions"in e)||e.expressions.length>0}));t(Object.assign(Object.assign({},r),{expressions:o}))}),[t,r]);if(!(null==r?void 0:r.expressions))return null;var o=r.expressions.length;return l.a.createElement(l.a.Fragment,null,Array.from(r.expressions).map((function(e,t){return l.a.createElement(l.a.Fragment,{key:t},n({index:t,value:e,onChange:function(e){return a(t,e)},onAdd:function(e){return a(o,e)},onRemove:function(){return a(t)}}))})))},cn=n(9),fn=n.n(cn),pn=function(e){Object(u.useEffect)(e,[])},dn=function(e,t,n,r){if(t.multipleValues)return Array.isArray(n)?mn(e,n):mn(e,[n]);var a=vn(e,n);return G.a.isUndefined(a)?r:a},mn=function(e,t){return t.reduce((function(t,n){var r=vn(e,n);return G.a.isUndefined(r)||t.push(r),t}),[])},vn=function(e,t){switch(e.type){case D.Boolean:return yn(t,!1);case D.Number:return hn(t,0);default:return}},hn=function(e,t){return G.a.isNumber(e)?G.a.toNumber(e):"boolean"==typeof e?e?1:0:t},yn=function(e,t){if("boolean"==typeof e)return e;if("string"==typeof e){var n=G.a.toLower(G.a.trim(e));return!!G.a.startsWith(n,"t")||!!G.a.startsWith(n,"1")}return"number"==typeof e?e>0:t},bn=[{value:!0,label:"True"},{value:!1,label:"False"}],gn=function(e){var t=Object(u.useCallback)((function(t){t&&"boolean"==typeof t.value&&e.onChange({name:e.operator.value,value:t.value})}),[e]);return l.a.createElement(f.Select,{width:15,options:bn,value:e.value,onChange:t,menuPlacement:"bottom"})};function En(e){return(En="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function On(e){return function(e){if(Array.isArray(e))return wn(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return wn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return wn(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function wn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Sn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function jn(e,t){return(jn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Cn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=In(e);if(t){var a=In(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return An(this,n)}}function An(e,t){if(t&&("object"===En(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return Tn(e)}function Tn(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function In(e){return(In=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var xn=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&jn(e,t)}(i,e);var t,n,r,a=Cn(i);function i(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),(t=a.call(this,e)).onCreate=function(e){if(e){var n=(t.props.values||[]).concat(e);t.props.onChange({value:n,name:t.props.operator.value})}},t.onChange=function(e){Array.isArray(e)&&t.props.onChange({value:e.map((function(e){return e.value})),name:t.props.operator.value})},t.getSuggestions=function(e){return o(Tn(t),void 0,void 0,regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.setState({isLoading:!0}),t.next=3,this.props.getSuggestions(e);case 3:return n=t.sent,this.setState({defaultOptions:[this.props.templateVariableOptions].concat(On(n)),isLoading:!1}),t.abrupt("return",n);case 6:case"end":return t.stop()}}),t,this)})))},t.state={defaultOptions:[e.templateVariableOptions],isLoading:!1},t}return t=i,(n=[{key:"render",value:function(){var e=this,t=(this.props.values||[]).map((function(e){return{label:e,value:e}}));return l.a.createElement(f.AsyncMultiSelect,{width:30,placeholder:"Start typing to add filters...",loadOptions:this.getSuggestions,onOpenMenu:function(){return e.getSuggestions("")},defaultOptions:this.state.defaultOptions,isLoading:this.state.isLoading,value:t,onChange:this.onChange,onCreateOption:this.onCreate,noOptionsMessage:"No options found",isClearable:!0})}}])&&Sn(t.prototype,n),r&&Sn(t,r),i}(u.PureComponent);function Rn(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,a,o=[],i=!0,u=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(e){u=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(u)throw a}}return o}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return kn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return kn(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function kn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Nn=function(e){var t,n=Rn(Object(u.useState)(String(null!==(t=e.value)&&void 0!==t?t:0)),2),r=n[0],a=n[1],o=e.onChange,i=e.operator.value,s=Object(u.useCallback)((function(e){a(e.currentTarget.value)}),[a]),c=Object(u.useCallback)((function(e){o({name:i,value:Dn(e.currentTarget.value)})}),[o,i]);return l.a.createElement(f.Input,{width:30,value:r,onChange:s,onBlur:c})},Dn=function(e){return e?isNaN(e)?0:parseInt(e,10):0};function Fn(e){return(Fn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Pn(e){return function(e){if(Array.isArray(e))return Ln(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return Ln(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ln(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ln(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Mn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _n(e,t){return(_n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Vn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Bn(e);if(t){var a=Bn(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return zn(this,n)}}function zn(e,t){if(t&&("object"===Fn(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return $n(e)}function $n(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Bn(e){return(Bn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var qn=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_n(e,t)}(i,e);var t,n,r,a=Vn(i);function i(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),(t=a.call(this,e)).onChange=function(e){null!==e?t.props.onChange({value:"".concat(e.value),name:t.props.operator.value}):t.props.onChange({value:"",name:t.props.operator.value})},t.onCreate=function(e){e&&t.props.onChange({value:e,name:t.props.operator.value})},t.getSuggestions=function(e){return o($n(t),void 0,void 0,regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.setState({isLoading:!0}),t.next=3,this.props.getSuggestions(e);case 3:return n=t.sent,this.setState({defaultOptions:[this.props.templateVariableOptions].concat(Pn(n)),isLoading:!1}),t.abrupt("return",n);case 6:case"end":return t.stop()}}),t,this)})))},t.state={defaultOptions:[e.templateVariableOptions],isLoading:!1},t}return t=i,(n=[{key:"render",value:function(){var e=this,t=this.props.value,n=t?{label:t,value:t}:void 0;return l.a.createElement(f.AsyncSelect,{width:30,placeholder:"Start typing to add filters...",loadOptions:this.getSuggestions,onOpenMenu:function(){return e.getSuggestions(null!=t?t:"")},defaultOptions:this.state.defaultOptions,isLoading:this.state.isLoading,value:n,onChange:this.onChange,onCreateOption:this.onCreate,allowCustomValue:!0,backspaceRemovesValue:!0,isClearable:!0,noOptionsMessage:"No options found"})}}])&&Mn(t.prototype,n),r&&Mn(t,r),i}(u.PureComponent);function Un(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,a,o=[],i=!0,u=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(e){u=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(u)throw a}}return o}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Gn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Gn(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Gn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Wn,Xn=function(e){var t,n=Un(Object(u.useState)(null!==(t=e.value)&&void 0!==t?t:""),2),r=n[0],a=n[1],o=e.onChange,i=e.operator.value,s=Object(u.useCallback)((function(e){a(e.currentTarget.value)}),[a]),c=Object(u.useCallback)((function(e){o({name:i,value:e.currentTarget.value})}),[o,i]);return l.a.createElement(f.Input,{width:30,value:r,onChange:s,onBlur:c})};var Qn,Hn=function(e){return e.booleanValues?{name:e.value,value:!1}:e.multipleValues?{name:e.value,value:[]}:{name:e.value,value:""}},Kn=function(e){var t=e.operators,n=e.value,r=e.getSuggestions,o=e.templateVariableOptions,i=e.property,u=Object(f.useStyles2)(Zn),s=t.find((function(e){return e.value===(null==n?void 0:n.name)}));return l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:u.container},l.a.createElement(f.Select,{isSearchable:!0,options:t,value:null==s?void 0:s.value,onChange:function(t){if(t&&t.value){var n=e.property,r=e.value,a=e.operators.find((function(e){return e.value===t.value}));if(!a||!n)return;if(!r)return void e.onChange(Hn(a));var o=Hn(a),i=o.value,u=r.value;o.value=dn(n,a,u,i),e.onChange(o)}},menuPlacement:"bottom",renderControl:l.a.forwardRef((function(e,t){e.value,e.isOpen,e.invalid;var n=a(e,["value","isOpen","invalid"]);return l.a.createElement(f.Button,Object.assign({},n,{ref:t,variant:"secondary"}),(null==s?void 0:s.label)||(null==s?void 0:s.value)||"?")}))})),Jn(s,n,(function(t){e.onChange(t)}),r,o,u,null==i?void 0:i.type))},Jn=function(e,t,n,r,a,o,i){var u;return e?function(e,t){return t===D.DateTime&&"string"==typeof(null==e?void 0:e.value)}(t,i)?l.a.createElement("div",{className:o.container},l.a.createElement(Xn,{operator:e,value:null==t?void 0:t.value,onChange:n})):function(e,t){return t===D.Number&&"number"==typeof(null==e?void 0:e.value)}(t,i)?l.a.createElement("div",{className:o.container},l.a.createElement(Nn,{operator:e,value:null==t?void 0:t.value,onChange:n})):!e.multipleValues||!z(t)&&t?!e.booleanValues||!function(e){return"boolean"==typeof(null==e?void 0:e.value)}(t)&&t?e.multipleValues||!function(e){return!z(e)}(t)&&t?null:l.a.createElement("div",{className:o.container},l.a.createElement(qn,{operator:e,value:null==t?void 0:t.value,onChange:n,getSuggestions:r,templateVariableOptions:a})):l.a.createElement("div",{className:o.container},l.a.createElement(gn,{operator:e,value:null==t?void 0:t.value,onChange:n})):l.a.createElement("div",{className:o.container},l.a.createElement(xn,{operator:e,values:null!==(u=null==t?void 0:t.value)&&void 0!==u?u:[],onChange:n,getSuggestions:r,templateVariableOptions:a})):null},Zn=function(e){return{container:Object(Ge.css)(Wn||(t=["\n    margin-right: 4px;\n    /* when Grafanas Select has labels */\n    div[class*='grafana-select-option-description'] {\n      white-space: nowrap;\n    }\n    /* fallback until Grafanas Select has labels */\n    [aria-label*='Select options menu'] {\n      div {\n        div {\n          div {\n            div {\n              div {\n                white-space: nowrap;\n              }\n            }\n          }\n        }\n      }\n    }\n  "],n||(n=t.slice(0)),Wn=Object.freeze(Object.defineProperties(t,{raw:{value:Object.freeze(n)}}))))};var t,n};function Yn(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,a,o=[],i=!0,u=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(e){u=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(u)throw a}}return o}(e,t)||er(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function er(e,t){if(e){if("string"==typeof e)return tr(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?tr(e,t):void 0}}function tr(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var nr,rr,ar,or,ir=function(e){var t=Yn(Object(u.useState)([]),2),n=t[0],r=t[1],a=function(t){var n,a=[],o=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=er(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,u=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){u=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(u)throw o}}}}(e.operators);try{for(o.s();!(n=o.n()).done;){var i=n.value;i.supportTypes.includes(t.type)&&a.push(i)}}catch(e){o.e(e)}finally{o.f()}return r(a),a};pn((function(){var t,n=null===(t=e.value)||void 0===t?void 0:t.property;n&&a(n)}));var i=fn()((function(t){return o(void 0,void 0,void 0,regeneratorRuntime.mark((function n(){var r,a,o,i;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(e.value){n.next=2;break}return n.abrupt("return",[]);case 2:return a=lr(e.value.property,t),n.next=5,e.getSuggestions(a);case 5:return o=n.sent,Array.isArray(null===(r=e.templateVariableOptions)||void 0===r?void 0:r.options)&&(i=e.templateVariableOptions.options.filter((function(e){return"string"==typeof(null==e?void 0:e.value)&&e.value.indexOf(t)>-1})),Array.prototype.push.apply(o,i)),n.abrupt("return",o);case 8:case"end":return n.stop()}}),n)})))}),800,{leading:!1}),s=e.value,c=e.fields,p=e.templateVariableOptions,d=Object(f.useStyles2)(ur),m=(null==s?void 0:s.operator)||(null==s?void 0:s.property);return l.a.createElement("div",{className:d.container},l.a.createElement(Qt,{value:null==s?void 0:s.property,fields:c,templateVariableOptions:p,onChange:function(t){var n,r,o,i=Object.assign(Object.assign({},e.value),{property:t}),u=a(t),l=null===(n=i.operator)||void 0===n?void 0:n.name,s=u.find((function(e){return e.value===l}));if(u.length&&!s){i.operator=Hn(u[0]);var c=i.operator.value,f=null===(r=e.value)||void 0===r?void 0:r.operator.value;i.operator.value=dn(i.property,u[0],f,c)}if(!s)return e.onChange(i);i.operator=Hn(s);var p=i.operator.value,d=null===(o=e.value)||void 0===o?void 0:o.operator.value;i.operator.value=dn(i.property,s,d,p),e.onChange(i)},placeholder:"Choose column..."}),m&&l.a.createElement(Kn,{value:null==s?void 0:s.operator,operators:n,onChange:function(t){e.onChange(Object.assign(Object.assign({},e.value),{operator:t}))},getSuggestions:i,property:null==s?void 0:s.property,templateVariableOptions:p}))},ur=function(e){return{container:Object(Ge.css)(Qn||(t=["\n    display: flex;\n    flex-direction: row;\n  "],n||(n=t.slice(0)),Qn=Object.freeze(Object.defineProperties(t,{raw:{value:Object.freeze(n)}}))))};var t,n},lr=function(e,t){return t?{type:i.Operator,property:e,operator:{name:"contains",value:t}}:{type:i.Operator,property:e,operator:{name:"isnotempty",value:t}}};function sr(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}var cr=function(e){var t=Object(Ge.css)(nr||(nr=sr(["\n    display: flex;\n    flex-direction: row;\n  "])));return{container:Object(Ge.css)(rr||(rr=sr(["\n      display: flex;\n      flex-direction: column;\n    "]))),row:t,rowWithSpacing:Object(Ge.css)(ar||(ar=sr(["\n      ","\n      margin-top: 4px;\n    "])),t),spacing:Object(Ge.css)(or||(or=sr(["\n      margin-right: 4px;\n    "])))}};function fr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var pr=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.value=t,this.operators=n,this.label=t,this.types=[],this.description="",this.multiple=!1,this.bool=!1}var t,n,r;return t=e,(n=[{key:"withLabel",value:function(e){return this.label=e,this}},{key:"withDescription",value:function(e){return this.description=e,this}},{key:"supportTypes",value:function(e){return this.types=e,this}},{key:"multipleValues",value:function(e){return this.multiple=e,this}},{key:"booleanValues",value:function(e){return this.bool=e,this}},{key:"add",value:function(){this.operators.push({value:this.value,supportTypes:this.types,label:this.label,description:this.description,multipleValues:this.multiple,booleanValues:this.bool})}}])&&fr(t.prototype,n),r&&fr(t,r),e}();function dr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var mr=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.operators=[]}var t,n,r;return t=e,(n=[{key:"withOperators",value:function(e){var t=this;return e((function(e){return new pr(e,t.operators)})),this}},{key:"withMultipleRows",value:function(e){return this}},{key:"build",value:function(){return e={operators:this.operators,defaultValue:this.buildOperatorExpression()},function(t){var n,r,o=Object(f.useStyles2)(cr);return 0===(null===(r=null===(n=t.value)||void 0===n?void 0:n.expressions)||void 0===r?void 0:r.length)?l.a.createElement(dt,{label:t.label,tooltip:t.tooltip},l.a.createElement(f.Button,{variant:"secondary",onClick:function(){var n=Object.assign(Object.assign({},t.value),{expressions:[{type:i.Or,expressions:[e.defaultValue]}]});t.onChange(n)},icon:"plus"})):l.a.createElement(sn,{id:"filter-and",value:t.value,onChange:t.onChange},(function(n){var r,u;return B(n.value)?0===(null===(u=null===(r=n.value)||void 0===r?void 0:r.expressions)||void 0===u?void 0:u.length)?n.index>0?null:l.a.createElement(dt,{label:t.label,tooltip:t.tooltip},l.a.createElement(f.Button,{variant:"secondary",onClick:function(){var t={type:i.Or,expressions:[e.defaultValue]};n.onChange(t)},icon:"plus"})):l.a.createElement(dt,{label:t.label,tooltip:t.tooltip},l.a.createElement("div",{className:o.container},l.a.createElement(sn,{id:"filter-or",value:n.value,onChange:n.onChange},(function(r){if(!_(r.value))return null;var u,s=0===r.index,c=s?o.row:o.rowWithSpacing;return l.a.createElement("div",{className:c},!s&&l.a.createElement(f.InlineFormLabel,{className:"query-keyword",width:3},"or"),l.a.createElement(ir,{value:r.value,operators:e.operators,fields:t.fields,templateVariableOptions:t.templateVariableOptions,onChange:r.onChange,getSuggestions:(u="".concat(n.index,"-").concat(r.index),function(e){return t.getSuggestions(u,e)})}),l.a.createElement("div",{className:o.spacing},l.a.createElement(f.Button,{variant:"secondary",onClick:r.onRemove,icon:"minus"})),s&&l.a.createElement(f.Select,{isSearchable:!0,options:[{value:"append-row",label:"OR - include another option"},{value:"new-row",label:'AND - add a new "'.concat(t.label,'" clause')}],onChange:function(t){return"append-row"===(null==t?void 0:t.value)?r.onAdd(e.defaultValue):"new-row"===(null==t?void 0:t.value)?n.onAdd({type:i.Or,expressions:[e.defaultValue]}):void 0},menuPlacement:"bottom",renderControl:l.a.forwardRef((function(e,t){e.value,e.isOpen,e.invalid;var n=a(e,["value","isOpen","invalid"]);return l.a.createElement(f.Button,Object.assign({},n,{ref:t,variant:"secondary",icon:"plus"}))}))}))})))):null}))};var e}},{key:"buildOperatorExpression",value:function(){var e=this.operators[0];return{type:i.Operator,property:this.buildFieldExpression(),operator:Hn(e)}}},{key:"buildFieldExpression",value:function(){return{name:"",type:D.String}}}])&&dr(t.prototype,n),r&&dr(t,r),e}();function vr(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,a,o=[],i=!0,u=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(e){u=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(u)throw a}}return o}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return hr(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return hr(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function hr(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var yr,br,gr=function(e){var t,n=vr(Object(u.useState)(null!==(t=e.value)&&void 0!==t?t:""),2),r=n[0],a=n[1],o=Object(u.useCallback)((function(e){e&&e.currentTarget&&a(e.currentTarget.value)}),[a]),s=Object(u.useCallback)((function(){e.onChange({type:i.FunctionParameter,fieldType:e.fieldType,value:r,name:e.name})}),[r,e]);return l.a.createElement(f.Input,{width:20,value:r,placeholder:e.description,onChange:o,onBlur:s})};function Er(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}function Or(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,a,o=[],i=!0,u=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(e){u=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(u)throw a}}return o}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return wr(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return wr(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function wr(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Sr,jr,Cr,Ar,Tr=function(e){var t,n,r,a,o=e.value,s=e.functions,c=e.onChange,p=Or(Object(u.useState)(null===(t=e.value)||void 0===t?void 0:t.property),2),d=p[0],m=p[1],v=Or(Object(u.useState)(null===(n=e.value)||void 0===n?void 0:n.reduce),2),h=v[0],y=v[1],b=Or(Object(u.useState)(null===(r=e.value)||void 0===r?void 0:r.parameters),2),g=b[0],E=b[1],O=Rr(h,e.functions),w=Object(f.useStyles2)(Ir),S=Object(u.useCallback)((function(e){var t;if(m(e),!(null===(t=null==o?void 0:o.reduce)||void 0===t?void 0:t.name)){var n=s.find((function(e){return"avg"===e.value}));n||(n=s[0]),y({name:n.value,type:D.Function})}}),[m,o,s]),j=Object(u.useCallback)((function(e){y(e)}),[y]),C=Object(u.useCallback)((function(e){E(e)}),[E]);Object(u.useEffect)((function(){if(d&&h){var e={type:i.Reduce,property:d,reduce:h,parameters:g};c(e)}}),[d,h,g]);var A=xr(h,e.functions);return l.a.createElement("div",{className:w.container},l.a.createElement(Qt,{value:h,fields:e.functions,onChange:j,placeholder:"Choose aggregation function..."}),A.length>0&&l.a.createElement("div",{className:w.params},A.map((function(t){var n,r,a;return l.a.createElement(gr,{key:t.name,name:t.name,value:null===(a=null===(r=null===(n=e.value)||void 0===n?void 0:n.parameters)||void 0===r?void 0:r.find((function(e){return e.name===t.name})))||void 0===a?void 0:a.value,description:t.description,fieldType:t.type,onChange:function(e){return C([e])}})}))),O&&l.a.createElement(l.a.Fragment,null,l.a.createElement(f.InlineFormLabel,{width:2,className:"query-keyword"},null!==(a=e.label)&&void 0!==a?a:"of"),l.a.createElement(Qt,{value:d,fields:e.fields,templateVariableOptions:e.templateVariableOptions,onChange:S,placeholder:"Choose column..."})))},Ir=function(e){return{container:Object(Ge.css)(yr||(yr=Er(["\n    display: flex;\n    flex-direction: row;\n  "]))),params:Object(Ge.css)(br||(br=Er(["\n    margin-right: 4px;\n  "])))}},xr=function(e,t){if(!e)return[];var n=t.find((function(t){return t.value===e.name}));return(null==n?void 0:n.parameters)||[]},Rr=function(e,t){return Object(u.useMemo)((function(){var n,r,a;if(!e)return null===(r=null===(n=t[0])||void 0===n?void 0:n.applyOnField)||void 0===r||r;var o=t.find((function(t){return t.value===e.name}));return null===(a=null==o?void 0:o.applyOnField)||void 0===a||a}),[t,e])};function kr(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}var Nr=function(e){var t=Object(Ge.css)(Sr||(Sr=kr(["\n    display: flex;\n    flex-direction: row;\n  "])));return{container:Object(Ge.css)(jr||(jr=kr(["\n      display: flex;\n      flex-direction: column;\n    "]))),row:t,rowWithSpacing:Object(Ge.css)(Cr||(Cr=kr(["\n      ","\n      margin-top: 4px;\n    "])),t),spacing:Object(Ge.css)(Ar||(Ar=kr(["\n      margin-right: 4px;\n    "])))}};function Dr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Fr=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.value=t,this.functions=n,this.appliedOnField=!0,this.parameters=[],this.label=t}var t,n,r;return t=e,(n=[{key:"withLabel",value:function(e){return this.label=e,this}},{key:"withParameter",value:function(e,t,n){return this.parameters.push({name:e,type:t,description:n}),this}},{key:"isAppliedOnField",value:function(e){return this.appliedOnField=e,this}},{key:"add",value:function(){this.functions.push({value:this.value,label:this.label,type:D.Function,parameters:this.parameters,applyOnField:this.appliedOnField})}}])&&Dr(t.prototype,n),r&&Dr(t,r),e}();function Pr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Lr,Mr=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.functions=[]}var t,n,r;return t=e,(n=[{key:"withMultipleRows",value:function(e){return this}},{key:"withFunctions",value:function(e){var t=this;return e((function(e){return new Fr(e,t.functions)})),this}},{key:"build",value:function(){return e={functions:this.functions,defaultValue:this.buildReduceExpression()},function(t){var n=Object(f.useStyles2)(Nr);return 0===t.value.expressions.length?l.a.createElement(dt,{label:t.label,tooltip:t.tooltip},l.a.createElement(f.Button,{variant:"secondary",onClick:function(){var n=Object.assign(Object.assign({},t.value),{expressions:[e.defaultValue]});t.onChange(n)},icon:"plus"})):l.a.createElement(dt,{label:t.label,tooltip:t.tooltip},l.a.createElement("div",{className:n.container},l.a.createElement(sn,{id:"reduce",onChange:t.onChange,value:t.value},(function(r){if(!L(r.value))return null;var a=0===r.index,o=a?n.row:n.rowWithSpacing;return l.a.createElement("div",{className:o},l.a.createElement(Tr,{onChange:r.onChange,value:r.value,templateVariableOptions:t.templateVariableOptions,fields:t.fields,functions:e.functions}),l.a.createElement(f.Button,{className:n.spacing,variant:"secondary",onClick:r.onRemove,icon:"minus"}),a&&l.a.createElement(f.Button,{variant:"secondary",onClick:function(){return r.onAdd(e.defaultValue)},icon:"plus"}))}))))};var e}},{key:"buildReduceExpression",value:function(){return{type:i.Reduce,property:this.buildProperty(D.String),reduce:this.buildProperty(D.Function)}}},{key:"buildProperty",value:function(e){return{name:"",type:e}}}])&&Pr(t.prototype,n),r&&Pr(t,r),e}();function _r(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,a,o=[],i=!0,u=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(e){u=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(u)throw a}}return o}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Vr(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Vr(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Vr(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var zr,$r,Br,qr,Ur=function(e){var t,n,r=e.intervals,a=e.onChange,o=_r(Object(u.useState)(null===(t=e.value)||void 0===t?void 0:t.property),2),s=o[0],c=o[1],p=_r(Object(u.useState)(null===(n=e.value)||void 0===n?void 0:n.interval),2),d=p[0],m=p[1],v=Object(f.useStyles2)(Gr),h=Object(u.useCallback)((function(e){c(e),e.type===D.DateTime&&m({type:D.Interval,name:r[0].value})}),[c,r]),y=Object(u.useCallback)((function(e){m(e)}),[m]);return Object(u.useEffect)((function(){if(s){var e={type:i.GroupBy,property:s,interval:d};a(e)}}),[s,d]),l.a.createElement("div",{className:v.container},l.a.createElement(Qt,{value:s,fields:e.fields,templateVariableOptions:e.templateVariableOptions,onChange:h,placeholder:"Choose column..."}),(null==s?void 0:s.type)===D.DateTime&&l.a.createElement(Qt,{value:d,fields:e.intervals,templateVariableOptions:e.templateVariableOptions,onChange:y,placeholder:"Choose interval",allowCustom:!0}))},Gr=function(e){return{container:Object(Ge.css)(Lr||(t=["\n    display: flex;\n    flex-direction: row;\n  "],n||(n=t.slice(0)),Lr=Object.freeze(Object.defineProperties(t,{raw:{value:Object.freeze(n)}}))))};var t,n};function Wr(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}var Xr=function(e){var t=Object(Ge.css)(zr||(zr=Wr(["\n    display: flex;\n    flex-direction: row;\n  "])));return{container:Object(Ge.css)($r||($r=Wr(["\n      display: flex;\n      flex-direction: column;\n    "]))),row:t,rowWithSpacing:Object(Ge.css)(Br||(Br=Wr(["\n      ","\n      margin-top: 4px;\n    "])),t),spacing:Object(Ge.css)(qr||(qr=Wr(["\n      margin-right: 4px;\n    "])))}};function Qr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Hr=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.value=t,this.intervals=n,this.label=t}var t,n,r;return t=e,(n=[{key:"withLabel",value:function(e){return this.label=e,this}},{key:"add",value:function(){this.intervals.push({value:this.value,label:this.label,type:D.Interval})}}])&&Qr(t.prototype,n),r&&Qr(t,r),e}();function Kr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Jr,Zr=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.intervals=[]}var t,n,r;return t=e,(n=[{key:"withMultipleRows",value:function(e){return this}},{key:"withIntervals",value:function(e){var t=this;return e((function(e){return new Hr(e,t.intervals)})),this}},{key:"build",value:function(){return e={intervals:this.intervals,defaultValue:this.buildGroupByExpressions()},function(t){var n=Object(f.useStyles2)(Xr);return 0===t.value.expressions.length?l.a.createElement(dt,{label:t.label,tooltip:t.tooltip},l.a.createElement(f.Button,{variant:"secondary",onClick:function(){var n=Object.assign(Object.assign({},t.value),{expressions:[e.defaultValue]});t.onChange(n)},icon:"plus"})):l.a.createElement(dt,{label:t.label,tooltip:t.tooltip},l.a.createElement("div",{className:n.container},l.a.createElement(sn,{id:"group-by",onChange:t.onChange,value:t.value},(function(r){if(!V(r.value))return null;var a=0===r.index,o=a?n.row:n.rowWithSpacing;return l.a.createElement("div",{className:o},l.a.createElement(Ur,{onChange:r.onChange,value:r.value,templateVariableOptions:t.templateVariableOptions,fields:t.fields,intervals:e.intervals}),l.a.createElement(f.Button,{className:n.spacing,variant:"secondary",onClick:r.onRemove,icon:"minus"}),a&&l.a.createElement(f.Button,{variant:"secondary",onClick:function(){return r.onAdd(e.defaultValue)},icon:"plus"}))}))))};var e}},{key:"buildGroupByExpressions",value:function(){return{type:i.GroupBy,property:{name:"",type:D.String}}}}])&&Kr(t.prototype,n),r&&Kr(t,r),e}(),Yr=function(e){return e.build()}(new on),ea=function(e){return e(new mr)}((function(e){return e.withOperators((function(e){e("==").supportTypes([D.String,D.Number,D.DateTime]).withDescription("equal to").add(),e("==").supportTypes([D.Boolean]).withDescription("equal to").booleanValues(!0).add(),e("!=").supportTypes([D.String,D.Number,D.DateTime]).withDescription("not equal to").add(),e("!=").supportTypes([D.Boolean]).withDescription("not equal to").booleanValues(!0).add(),e(">").supportTypes([D.Number,D.DateTime,D.TimeSpan]).withDescription("greater than").add(),e("<").supportTypes([D.Number,D.DateTime,D.TimeSpan]).withDescription("less than").add(),e("=~").supportTypes([D.String]).withDescription("equal to (case-insensitive)").add(),e("!~").supportTypes([D.String]).withDescription("not equal to (case-insensitive)").add(),e("in").supportTypes([D.String]).withDescription("in (case-sensitive)").multipleValues(!0).add(),e("in~").supportTypes([D.String]).withDescription("in (case-insensitive)").multipleValues(!0).add(),e("!in").supportTypes([D.String]).withDescription("not in (case-sensitive)").multipleValues(!0).add(),e("!in~").supportTypes([D.String]).withDescription("not in (case-insensitive)").multipleValues(!0).add(),e("contains").supportTypes([D.String]).withDescription("contains substring").multipleValues(!1).add(),e("!contains").supportTypes([D.String]).withDescription("does not contain substring").multipleValues(!1).add(),e("contains_cs").supportTypes([D.String]).withDescription("contains substring (case-sensitive)").multipleValues(!1).add(),e("!contains_cs").supportTypes([D.String]).withDescription("does not contain substring (case-sensitive)").multipleValues(!1).add(),e("endswith").supportTypes([D.String]).withDescription("ends with").multipleValues(!1).add(),e("!endswith").supportTypes([D.String]).withDescription("does not end with").multipleValues(!1).add(),e("endswith_cs").supportTypes([D.String]).withDescription("ends with (case-sensitive)").multipleValues(!1).add(),e("!endswith_cs").supportTypes([D.String]).withDescription("does not end with (case-sensitive)").multipleValues(!1).add(),e("startswith").supportTypes([D.String]).withDescription("starts with").multipleValues(!1).add(),e("!startsswith").supportTypes([D.String]).withDescription("does not start with").multipleValues(!1).add(),e("startswith_cs").supportTypes([D.String]).withDescription("starts with (case-sensitive)").multipleValues(!1).add(),e("!startswith_cs").supportTypes([D.String]).withDescription("does not start with (case-sensitive)").multipleValues(!1).add(),e("matches regex").supportTypes([D.String]).withDescription("regex string matching").multipleValues(!1).add(),e("has_any").supportTypes([D.String]).withDescription("any provided values matching").multipleValues(!0).add(),e("has").supportTypes([D.String]).withDescription("match if whole term exists in column").multipleValues(!1).add(),e("!has").supportTypes([D.String]).withDescription("match if whole term not exists in column").multipleValues(!1).add()})).withMultipleRows(!0).build()})),ta=function(e){return e(new Mr)}((function(e){return e.withFunctions((function(e){e("sum").withLabel("Sum").add(),e("avg").withLabel("Avg").add(),e("count").isAppliedOnField(!1).withLabel("Count").add(),e("dcount").withLabel("Dcount").add(),e("max").withLabel("Max").add(),e("min").withLabel("Min").add(),e("percentile").withLabel("Percentile").withParameter("percentileParam",D.Number,"percentile constant").add()})).withMultipleRows(!0).build()})),na=function(e){return e(new Zr)}((function(e){return e.withIntervals((function(e){e("$__timeInterval").withLabel("auto").add(),e("1m").withLabel("1 minute").add(),e("5m").withLabel("5 minutes").add(),e("15m").withLabel("15 minutes").add(),e("30m").withLabel("30 minutes").add(),e("1h").withLabel("1 hour").add(),e("6h").withLabel("6 hours").add(),e("12h").withLabel("12 hours").add(),e("1d").withLabel("1 day").add()})).withMultipleRows(!0).build()}));var ra=function(e){var t,n,r,a,i,c,p,d,m,v,b,g,E,O,w,S=e.query,j=e.database,C=e.datasource,A=e.schema,T=e.onChangeQuery,I=C.id,x=C.parseExpression,R=C.autoCompleteQuery,k=C.getSchemaMapper,N=St(S.resultFormat),D=Object(s.getTemplateSrv)().replace(j),F=sa(A,D,C),P=la(F,S,C),L=Object(s.getTemplateSrv)().replace(null!==(t=null==P?void 0:P.property.name)&&void 0!==t?t:""),_=k().getMappingByValue(null==P?void 0:P.property.name),V=fa(),z=Object(f.useStyles2)(aa),$=ft((function(){return o(void 0,void 0,void 0,regeneratorRuntime.mark((function e(){var t,n,r,a,o,i,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(P&&P.property){e.next=2;break}return e.abrupt("return",[]);case 2:return a=null!==(t=null==_?void 0:_.value)&&void 0!==t?t:L,e.next=5,ca(C,D,a);case 5:return o=e.sent,i=null!==(n=S.expression)&&void 0!==n?n:h.expression,u=null!==(r=i.from)&&void 0!==r?r:P,T(Object.assign(Object.assign({},S),{query:x(Object.assign(Object.assign({},i),{from:u}),o)})),e.abrupt("return",o);case 10:case"end":return e.stop()}}),e)})))}),[I,D,L,null==_?void 0:_.value]),B=Object(u.useCallback)((function(e,t){return o(void 0,void 0,void 0,regeneratorRuntime.mark((function n(){var r;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,R({search:t,database:D,expression:S.expression,index:e},$.value);case 2:return r=n.sent,n.abrupt("return",r.map((function(e){return{value:e,label:e}})));case 4:case"end":return n.stop()}}),n)})))}),[R,D,$.value,S.expression]),q=ua($.value),U=oa(q),G=ia(q),W=Object(u.useCallback)((function(e){if(M(e)&&P){var t=Object.assign(Object.assign({},h.expression),{from:e});T(Object.assign(Object.assign({},S),{resultFormat:N,database:j,expression:t}))}}),[T,S,N,j,P]),X=Object(u.useCallback)((function(e){var t=Object.assign(Object.assign({},S.expression),{from:P,where:e});T(Object.assign(Object.assign({},S),{resultFormat:N,database:j,expression:t,query:x(t,$.value)}))}),[T,S,$.value,N,j,P,x]),Q=Object(u.useCallback)((function(e){var t=Object.assign(Object.assign({},S.expression),{from:P,reduce:e});T(Object.assign(Object.assign({},S),{resultFormat:N,database:j,expression:t,query:x(t,$.value)}))}),[T,S,$.value,N,j,P,x]),H=Object(u.useCallback)((function(e){var t=Object.assign(Object.assign({},S.expression),{from:P,groupBy:e});T(Object.assign(Object.assign({},S),{resultFormat:N,database:j,expression:t,query:x(t,$.value)}))}),[T,S,$.value,N,j,P,x]),K=Object(u.useCallback)((function(e){var t=Object.assign(Object.assign({},S.expression),{from:P});T(Object.assign(Object.assign({},S),{expression:t,database:j,resultFormat:e}))}),[T,P,j,S]),J=Object(u.useCallback)((function(e){if(M(e)&&P){var t=Object.assign(Object.assign(Object.assign({},h.expression),S.expression),{from:P,timeshift:e});T(Object.assign(Object.assign({},S),{resultFormat:N,database:j,expression:t,query:x(t,$.value)}))}}),[T,S,N,j,P,x,$.value]),Z=function(t){return l.a.createElement(Yr,{templateVariableOptions:e.templateVariableOptions,label:"From",value:P,fields:F,onChange:W,"aria-label":y.queryEditor.tableFrom.input},t.children)};return $.loading?l.a.createElement(l.a.Fragment,null,l.a.createElement(Z,null),l.a.createElement(Xe,null)):$.error?l.a.createElement(l.a.Fragment,null,l.a.createElement(Z,null),l.a.createElement(Qe,{message:"Could not load table schema: ".concat(null===(n=$.error)||void 0===n?void 0:n.message)})):0===(null===(r=$.value)||void 0===r?void 0:r.length)?l.a.createElement(l.a.Fragment,null,l.a.createElement(Z,null),l.a.createElement(He,{message:"Table schema loaded successfully but without any columns"})):l.a.createElement(l.a.Fragment,null,l.a.createElement(Z,null,l.a.createElement(Ot,{format:N,includeAdxTimeFormat:!1,onChangeFormat:K})),l.a.createElement(ea,{templateVariableOptions:e.templateVariableOptions,label:"Where (filter)",value:null!==(i=null===(a=S.expression)||void 0===a?void 0:a.where)&&void 0!==i?i:null===(c=h.expression)||void 0===c?void 0:c.where,fields:q,onChange:X,getSuggestions:B}),l.a.createElement(ta,{templateVariableOptions:e.templateVariableOptions,label:"Aggregate",value:null!==(d=null===(p=S.expression)||void 0===p?void 0:p.reduce)&&void 0!==d?d:null===(m=h.expression)||void 0===m?void 0:m.reduce,fields:G,onChange:Q}),l.a.createElement(na,{templateVariableOptions:e.templateVariableOptions,label:"Group by",value:null!==(b=null===(v=S.expression)||void 0===v?void 0:v.groupBy)&&void 0!==b?b:null===(g=h.expression)||void 0===g?void 0:g.groupBy,fields:U,onChange:H}),l.a.createElement("hr",null),l.a.createElement(Yr,{templateVariableOptions:[],label:"Timeshift",value:null!==(O=null===(E=S.expression)||void 0===E?void 0:E.timeshift)&&void 0!==O?O:null===(w=h.expression)||void 0===w?void 0:w.timeshift,fields:V,onChange:J,allowCustom:!0}),l.a.createElement("div",{className:z.query},l.a.createElement(f.TextArea,{cols:80,rows:8,value:e.query.query,disabled:!0})))},aa=function(e){return{query:Object(Ge.css)(Jr||(t=["\n    margin-top: 12px;\n  "],n||(n=t.slice(0)),Jr=Object.freeze(Object.defineProperties(t,{raw:{value:Object.freeze(n)}}))))};var t,n},oa=function(e){return Object(u.useMemo)((function(){return e.filter((function(e){return e.type===D.DateTime||D.String}))}),[e])},ia=function(e){return Object(u.useMemo)((function(){return e.filter((function(e){return e.type===D.DateTime||D.String}))}),[e])},ua=function(e){return Object(u.useMemo)((function(){return e?(t=e,Array.isArray(t)?t.map((function(e){return{value:e.Name,label:e.Name.replace(new RegExp(Object(U.escapeRegExp)('["`indexer`"]'),"g"),"[ ]"),type:oe(e.CslType)}})):[]):[];var t}),[e])},la=function(e,t,n){var r,a,o=n.getVariables(),l=null===(a=null===(r=t.expression)||void 0===r?void 0:r.from)||void 0===a?void 0:a.property.name;return Object(u.useMemo)((function(){var t=e.find((function(e){return e.value===l}));if(t)return{type:i.Property,property:Xt(t)};var n=o.find((function(e){return e===l}));return n?{type:i.Property,property:{name:n,type:D.String}}:e.length>0?{type:i.Property,property:Xt(e[0])}:void 0}),[e,l,o])},sa=function(e,t,n){var r=n.getSchemaMapper();return Object(u.useMemo)((function(){return e&&e.Databases?r.getTableOptions(e,t):[]}),[t,e,r])};function ca(e,t,n){return o(this,void 0,void 0,regeneratorRuntime.mark((function r(){var a;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=new nn(e),r.next=3,a.getColumnsForTable(t,n);case 3:return r.abrupt("return",r.sent);case 4:case"end":return r.stop()}}),r)})))}var fa=function(){return Object(u.useMemo)((function(){return[{label:"No timeshift",value:"",type:D.TimeSpan},{label:"Hour before",value:"1h",type:D.TimeSpan},{label:"Day before",value:"1d",type:D.TimeSpan},{label:"Week before",value:"7d",type:D.TimeSpan}]}),[])};function pa(e){return function(e){if(Array.isArray(e))return da(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return da(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return da(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function da(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var ma=function(e,t,n){var r=n.getVariables();return Object(u.useMemo)((function(){var n=e.find((function(e){return e.value===t.database}));if(n)return n.value;var a=r.find((function(e){return e===t.database}));return a||(e.length>0?e[0].value:"")}),[e,r,t.database])},va=function(e){return Object(u.useMemo)((function(){var t=[];if(!e||!e.Databases)return t;for(var n=0,r=Object.keys(e.Databases);n<r.length;n++){var a=r[n],o=e.Databases[a];t.push(ae(o))}return t}),[e])},ha=function(e){return Object(u.useMemo)((function(){var t,n,r;return null!==(r=null===(n=null===(t=null==e?void 0:e.series[0])||void 0===t?void 0:t.meta)||void 0===n?void 0:n.executedQueryString)&&void 0!==r?r:""}),[e])},ya=function(e,t){return Object(u.useMemo)((function(){return e!==t}),[e,t])},ba=function(e){return Object(u.useMemo)((function(){var t;return null===(t=null==e?void 0:e.error)||void 0===t?void 0:t.message}),[e])},ga=function(e){var t=e.getVariables();return Object(u.useMemo)((function(){return{label:"Template Variables",expanded:!1,options:t.map((function(e){return{label:e,value:e}}))}}),[t])};n.d(t,"plugin",(function(){return Ea}));var Ea=new r.DataSourcePlugin(_e).setConfigEditor(F).setQueryEditor((function(e){var t,n,r,a,o=e.datasource,i=e.onChange,s=e.onRunQuery,c=e.query,f=o,d=ha(e.data),m=ba(e.data),v=ya(e.query.query,d),y=function(e){var t;if(void 0===e.query.rawMode&&e.query.query&&!(null===(t=e.query.expression)||void 0===t?void 0:t.from))return!0;return e.query.rawMode||!1}(e),b=ft((function(){return f.getSchema(!1)}),[o.id]),g=ga(f),E=va(b.value),O=ma(E,e.query,f);Object(u.useEffect)((function(){(function(e){return!!e&&(!e.pluginVersion||(!e.querySource||!!Ze(e.expression)))})(c)&&(i(function(e){return Object.assign(Object.assign(Object.assign({},h),e),{rawMode:lt(e),pluginVersion:h.pluginVersion,expression:(t=e.expression,Ze(t)?Ye(t):null!=t?t:h.expression)});var t}(c)),s()),function(e){return void 0===e.query.rawMode}(e)&&function(e){return e.datasource.getDefaultEditorMode()===p.Raw}(e)&&(i(Object.assign(Object.assign({},e.query),{rawMode:!0,querySource:p.Raw})),s())}),[]);var w=Object(u.useCallback)((function(e){i(Object.assign(Object.assign({},c),{database:e}))}),[i,c]),S=Object(u.useCallback)((function(){i(Object.assign(Object.assign({},c),{rawMode:!y,querySource:y?p.Visual:p.Raw}))}),[i,c,y]);if(b.loading)return l.a.createElement(Xe,null);if(b.error)return(null===(n=null===(t=b.error)||void 0===t?void 0:t.data)||void 0===n?void 0:n.Message)?l.a.createElement("div",{className:"gf-form"},l.a.createElement("pre",{className:"gf-form-pre alert alert-error"},"Could not load datasource schema due too: ",null===(a=null===(r=b.error)||void 0===r?void 0:r.data)||void 0===a?void 0:a.Message)):l.a.createElement("div",{className:"gf-form"},l.a.createElement("pre",{className:"gf-form-pre alert alert-error"},"Could not load datasource schema: ",String(b.error)));if(0===E.length)return l.a.createElement("div",{className:"gf-form"},l.a.createElement("pre",{className:"gf-form-pre alert alert-warning"},"Datasource schema loaded but without any databases and tables, please try again.."));var j=y?p.Raw:p.Visual;return l.a.createElement(l.a.Fragment,null,m&&l.a.createElement("div",{className:"gf-form"},l.a.createElement("pre",{className:"gf-form-pre alert alert-warning"},"Failed to execute query: ",m)),l.a.createElement(yt,{onRunQuery:e.onRunQuery,onToggleEditorMode:S,editorMode:j,onChangeDatabase:w,database:O,databases:[g].concat(pa(E)),dirty:v}),j===p.Raw&&l.a.createElement($t,Object.assign({},e,{schema:b.value,templateVariableOptions:g,lastQuery:d,database:O})),j===p.Visual&&l.a.createElement(ra,{datasource:f,database:O,onChangeQuery:e.onChange,query:e.query,schema:b.value,templateVariableOptions:g}))}))}])}));
//# sourceMappingURL=module.js.map